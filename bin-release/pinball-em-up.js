/*! pinball-em-up 05-09-2014 */
window.onload=function(){"use strict";function a(){function a(a,b){var c=4;B(eb,vb,ub,2),eb.beginPath(),eb.moveTo(a(-c),b(-c)),eb.lineTo(a(S+T),b(-c)),eb.lineTo(a(S+T),b(S)),eb.arcTo(a(S+T),b(S+T),a(S),b(S+T),T),eb.lineTo(a(-c),b(S+T)),eb.closePath(),eb.fill(),eb.stroke(),j(k(a(S),b(S),T,Eb)),j(l(a(0),b(S+T),a(S),b(S+T),Eb)),j(l(a(S+T),b(0),a(S+T),b(S),Eb)),B(eb,xb);var h=a==q?f:g;eb.fillText(Q(h),a(S+T+130)-2,b(50)-3),h=b==q?d:e,eb.fillText(Q(h),a(50)-2,b(S+T+130)-3)}var b=z(cb,cb),c=A(b);C(c,0,0,cb,cb,rb),C(c,0,0,cb-1,cb-1,sb),C(c,0,0,cb-2,cb-2,qb),C(eb,0,0,ab,ab,b),F(eb,0,0,ab,ab,tb),F(eb,ab,0,0,ab,tb),E(eb,bb,bb,8,qb,tb);var d=8679,e=8681,f=8678,g=8680;eb.font="64px sans-serif",eb.textAlign="center",eb.textBaseline="middle",a(q,q),a(q,r),a(r,q),a(r,r);var h=40,i=h/2;b.width=300,b.height=100,c.translate(4,4),B(c,"#aef","#5af",2),c.beginPath(),c.moveTo(i,0),c.quadraticCurveTo(h,-3,h,i),c.quadraticCurveTo(h,h+1,i,h-2),c.quadraticCurveTo(2,h,0,i),c.quadraticCurveTo(-3,-1,i,0),c.fill(),c.stroke(),F(c,8,4,4,20,"#fff",2),F(c,16,2,8,26,0,1),F(c,36,14,18,36,0,1),F(c,38,18,26,36,0,2),F(c,i-4,10,i-4,18,"#58f",2),F(c,i+4,10,i+4,18),c.translate(h+8,0),B(c,"#fa0","#f00",2),c.beginPath(),c.moveTo(i,-4),c.lineTo(i+6,14),c.lineTo(h-4,8),c.quadraticCurveTo(h,h+3,i,h-2),c.quadraticCurveTo(2,h,4,8),c.lineTo(i-6,14),c.lineTo(i,-4),c.fill(),c.stroke(),F(c,i-3,26,i-8,20),F(c,i+3,26,i+8,20),c.translate(h+8,0),B(c,"#fd7","#d72",2),c.beginPath(),c.moveTo(i,0),c.quadraticCurveTo(h,10,h-8,h-8),c.quadraticCurveTo(h,h+1,i+2,h-6),c.quadraticCurveTo(14,h-12,2,h-4),c.quadraticCurveTo(-2,h-10,4,i),c.quadraticCurveTo(0,0,i,0),c.fill(),c.stroke(),E(c,10,7,1,"#d72"),E(c,24,9,1,"#d72"),E(c,7,20,1,"#d72"),E(c,20,14,1,"#d72"),E(c,8,30,1,"#d72"),E(c,28,32,1,"#d72"),c.scale(1,1.5),E(c,13,14,4,"#111","#d72",1),c.scale(1,2/3),c.stroke(),c.scale(1,1.5),E(c,26,14,4,"#111","#d72",1),c.scale(1,2/3),c.stroke(),c.translate(h+8,0),c.lineCap="round",B(c,0,"red",4),c.beginPath(),c.arc(i,i-2,i,.6,2.54),c.stroke(),c.beginPath(),c.arc(i,i-10,i+5,1,2.14),c.stroke(),E(c,i,i,i-4,"rgba(255,255,255,0.1)","#fff",2),B(0,0,1),c.beginPath(),c.arc(i,i,i-8,3.2,4.4),c.stroke(),E(c,i-4,i+4,4,0,"#fff",2),E(c,i+4,i+4,4,0,"#fff",2),D(eb,b,bb,1.5*bb)}function b(){Qb=0,Pb=!1,lb=[],mb=[],mb.n=0,a(),h()}function c(){if(!Pb){if(Nb.space)Qb++;else if(Qb>0){var a=Qb/Rb;a>1&&(a=1),nb.boostX=3*(1+P()),nb.boostY=-Jb,nb.boostCpt=10+50*a,Pb=!0}Nb.R&&(Pb=!0)}for(var b=0;b<ob.length;b++){var c,d=ob[b],e=!d.mirror;c=1==d.table?e?Nb.up||Nb.right:Nb.down||Nb.left:e?Nb.up||Nb.left:Nb.down||Nb.right;var f=d.ux,g=d.uy;d.cpt=d.cpt||0;var h=7;if(d.max=!1,c?d.cpt<h?d.cpt++:d.max=!0:d.cpt>0&&d.cpt--,d.prevX2=d.x2,d.prevY2=d.y2,d.movingUp=c&&!d.max,d.moving=0!==d.cpt,d.cpt>0){var j=d.amax*(d.cpt/h);d.mirror&&(j*=-1);var k=M.cos(j),l=M.sin(j);f=d.ux*k-d.uy*l,g=d.ux*l+d.uy*k}d._ux=f,d._uy=g,d.x2=d.x+f,d.y2=d.y+g}if(Ob.middle&&(Qb=0,Pb=!0,nb.x=Ob.x,nb.y=Ob.y,nb.a.x=nb.a.y=0,nb.v.x=nb.v.y=0,nb.boostCpt=0,Ob.right=!1,console.log("mouse teleport",nb)),Ob.right&&(Tb.x=Ob.x-nb.x,Tb.y=Ob.y-nb.y,u(Tb),nb.boostCpt=6,nb.boostX=2.5*Tb.x,nb.boostY=2.5*Tb.y,Ob.right=!1),Ob.left&&(Tb.x=Ob.x-nb.x,Tb.y=Ob.y-nb.y,u(Tb),Ob.leftCpt%10===0)){var m;mb.length==mb.n?(m=i(Cb,Ib),mb.push(m)):m=mb[mb.n],mb.n++;var n=10;m.x=nb.x+Tb.x*(n+Kb),m.y=nb.y+Tb.y*(n+Kb),m.v.x=Tb.x*n,m.v.y=Tb.y*n,m.cpt=100}Ob.left?Ob.leftCpt++:Ob.leftCpt=0}function d(){var a,b,c;for(a=0,b=pb.length;b>a;a++)c=pb[a],c.a=c.a+2*c.da*N,c.x=bb+M.cos(c.a)*c.d,c.y=bb+M.sin(c.a)*c.d;if(Pb){nb.boostCpt>0&&(nb.boostCpt--,nb.a.x=nb.boostX,nb.a.y=nb.boostY);var d=0,e=0,f=Lb;s=bb-nb.x,z=bb-nb.y;var g=V/2,h=t(s,z);g>h&&(s/=h,z/=h,f*=.1+.9*h/g);var i=nb.x-bb,j=nb.y-bb;j>i?j>-i?e=f:d=-f:j>-i?d=f:e=-f,nb.a.x+=d,nb.a.y+=e,nb.v.x=nb.v.x+nb.a.x,nb.v.y=nb.v.y+nb.a.y,nb.v.x*=Mb,nb.v.y*=Mb,nb.v.x*nb.v.x+nb.v.y*nb.v.y>Jb*Jb&&u(nb.v,Jb),nb.x+=nb.v.x,nb.y+=nb.v.y,nb.collide=!1;{nb.v.x,nb.v.y}for(a=0,b=lb.length;b>a;a++)if(c=lb[a],c!=nb){c.collide=!1;var k,l=Tb;if(c.shape==Bb)v(nb,c)&&(c.collide=!0,l.x=nb.x-c.x,Tb.y=nb.y-c.y,k=t(l.x,l.y),l.l=c.r+nb.r-k,l.x=l.x/k,l.y=l.y/k);else if(c.shape==Cb){var m=c.kind==Hb&&c.movingUp;if(!m&&w(nb,c,l)){c.collide=!0,x(Sb,c.x,c.y,c.x2,c.y2);var n=y(Sb,nb.x,nb.y)!==y(Sb,nb.prevX,nb.prevY);0>=n?k=nb.r-l.l:(k=nb.r+l.l,l.x*=-1,l.y*=-1),l.x/=l.l,l.y/=l.l,l.l=k}if(m){var o=w(nb,c,l),p=1==c.table||3==c.table;console.log("rising paddle",c,p?"REVERSE":"");var q,r;if(o?console.log(" paddle direct collision"):(x(Sb,c.x,c.y,c.prevX2,c.prevY2),q=y(Sb,nb.prevX,nb.prevY,p),console.log(" before",0,0,"and",c.prevX2-c.x,c.prevY2-c.y,q,"m",Sb.m,"p",Sb.p),console.log(" ball before:",nb.prevX-c.x,nb.prevY-c.y),x(Sb,c.x,c.y,c.x2,c.y2),r=y(Sb,nb.x,nb.y,p),console.log(" after",0,0,"and",c.x2-c.x,c.y2-c.y,r,"m",Sb.m,"p",Sb.p),console.log(" ball now:",nb.x-c.x,nb.y-c.y)),o||q!==r){o||console.log("  checking dotprod");var s=nb.x-c.x,z=nb.y-c.y,A=s*c._ux+z*c._uy;if((o||A>0)&&(o||s*s+z*z<c.l*c.l)){c.collide=!0;var B=(t(s,z),A/c.l);l.x=c.x+B*c._ux/c.l,l.y=c.y+B*c._uy/c.l,l.x=nb.x-l.x,l.y=nb.y-l.y,l.l=t(l.x,l.y),l.x/=l.l,l.y/=l.l;var C=c._uy/c.l,D=-c._ux/c.l;console.log("   NORMALE PAD",C,D,c),(c.mirror&&(0===c.table||3==c.table)||!c.mirror&&(1==c.table||2==c.table))&&(C*=-1,D*=-1);var E=C*l.x+D*l.y;0>E&&(l.x*=-1,l.y*=-1),l.l=l.l+nb.r,nb.x+=l.x*l.l,nb.y+=l.y*l.l,nb.collide=!0;var F=B/c.l;F=.2+(.3*F+.7*F*F);var G=20*F>>0,H=Jb*F,I=l.x*H,J=l.y*H;nb.boostCpt?(nb.boostCpt+=G>2?2:G,nb.boostX=.2*I+.8*nb.boostX,nb.boostY=.2*J+.8*nb.boostY):(nb.boostCpt=G,nb.boostX=I,nb.boostY=J),nb.boostX*=.6+.8*P(),nb.boostY*=.6+.8*P(),console.log("   boosting",F,nb.boostCpt,nb.boostX,nb.boostY);continue}}}}if(c.collide){c.colCpt=20,nb.x+=l.x*l.l,nb.y+=l.y*l.l,nb.collide=!0;var K=t(nb.v.x,nb.v.y),L=nb.v.x/K,O=nb.v.y/K,Q=-l.y,R=l.x,S=Q*L+R*O;0>S&&(Q=-Q,R=-R);var T=L*l.x+O*l.y;0>T&&(T=-T);var U=M.sin(M.acos(T));0>U&&(U=-U);var W=c.kind==Fb?1.5:.2;l.x*=T*W*K,l.y*=T*W*K,Q*=U*K,R*=U*K,nb.v.x=l.x+Q,nb.v.y=l.y+R}}nb.a.x=nb.a.y=0,nb.prevX=nb.x,nb.prevY=nb.y,nb.x+Kb<0?Pb=!1:nb.x-Kb>ab?Pb=!1:nb.y+Kb<0?Pb=!1:nb.y-Kb>ab&&(Pb=!1)}var X;for(a=0,b=mb.n;b>a;a++)X=mb[a],X.cpt--,X.cpt>0&&(X.x+=X.v.x,X.y+=X.v.y);for(a=0;a<mb.n;a++)X=mb[a],0===X.cpt&&(mb[a]=mb[mb.n-1],mb[mb.n-1]=X,mb.n--,a--)}function e(){$=Y,_=Z;var a=nb.x,b=nb.y,c=a-bb,d=b-bb,e=c,f=d;0>e&&(e*=-1),0>f&&(f*=-1);var g=R/2+T;if(g>e&&g>f){var h=e-g,i=f-g,j=h*h+i*i;if(g*g>j){var k=O(j);h=h*g/k,i=i*g/k,a=h+g,b=i+g,0>c&&(a=-a),0>d&&(b=-b),a=bb+a,b=bb+b}}else f>e?a=bb:b=bb;a=s(a,nb.x-.3*V,nb.x+.3*V),b=s(b,nb.y-.3*W,nb.y+.3*W),a=s(a-V/2,0,ab-V),b=s(b-W/2,0,ab-W),Pb?(Y+=.3*(a-Y),Z+=.3*(b-Z)):(Y=a,Z=b)}function f(){G(gb),G(kb),D(gb,hb,0,0),ib.clearRect(0,0,V,W),ib.save(),ib.globalAlpha=.9,D(ib,fb,-Y+$,-Z+_),ib.restore(),G(gb),nb.boostCpt>0?(E(ib,nb.x-Y,nb.y-Z,6,"orange"),E(ib,nb.prevX-Y,nb.prevY-Z,6,"orange")):E(ib,nb.x-Y,nb.y-Z,2,"white");for(var a=0,b=lb.length;b>a;a++){var c,d,e,f=lb[a],g=f.x-Y,h=f.y-Z;if(f==nb){if(Qb>0&&!Pb){var i=4*s(Qb/Rb,0,1)>>0;g+=i*P()>>0,h+=i*P()>>0,4==i&&(d="#f00")}var j=M.atan2(nb.v.y,nb.v.x);nb.cpt=++nb.cpt%20;var k=nb.cpt;k>10&&(k=20-k),0===k?E(kb,nb.x-Y,nb.y-Z,Kb,zb,yb):(B(kb,zb,yb,2),k*=.3*N/10,kb.beginPath(),kb.arc(nb.x-Y,nb.y-Z,nb.r,j+k,j-k),kb.lineTo(nb.x-Y,nb.y-Z),kb.closePath(),kb.fill(),kb.stroke())}else f.shape==Bb?(f.kind==Eb?(c=0,d=0):(e=2,d=ub,c="#000",f.colCpt>0&&(f.colCpt--,d=wb)),(c||d)&&E(kb,g,h,f.r,c,d,e)):f.shape==Cb&&(f.kind==Eb?d=0:(d=ub,f.kind==Hb&&(d=xb,f.collide&&(d=wb))),d&&F(kb,f.x-Y,f.y-Z,f.x2-Y,f.y2-Z,d,2))}var l;for(a=0,b=mb.n;b>a;a++)l=mb[a],E(kb,l.x-Y,l.y-Z,4,Ab),F(ib,l.x-Y,l.y-Z,l.x-l.v.x-Y,l.y-l.v.y-Z,Ab,2);D(gb,db,-Y,-Z),D(gb,hb,0,0),D(gb,jb,0,0)}function g(){c(),d(),e(),f(),window.requestAnimationFrame(g)}function h(){nb=j(k(bb,ab-50,Kb,Db)),nb.cpt=0,n(l(0,220,150,100,Gb)),pb=[];for(var a=10,b=0;a>b;b++){var c=20+30*P(),d=80+c+(U-2*c-80)*b/a>>0,e=2*P()*N,f=k(0,0,c,Fb);pb.push(j(f));var g=.1+.2*P()*(P()>.5?-1:1);f.da=g/(2*d*N),f.a=e,f.d=d,console.log(f.da)}n(l(150,100,300,30,Hb)),ob=lb.slice(-8);var h=ob[0],i=t(h.x-h.x2,h.y-h.y2),m=2*-M.acos((h.x2-h.x)/i);for(b=0;b<ob.length;b++)h=ob[b],h.l=i,h.ux=h.x2-h.x,h.uy=h.y2-h.y,h.amax=m,(1==h.table||2==h.table)&&(h.amax*=-1)}function i(a,b,c,d){return{x:c||0,y:d||0,shape:a,kind:b,v:{x:0,y:0},a:{x:0,y:0}}}function j(a){return lb.push(a),a}function k(a,b,c,d){var e=i(Bb,d,a,b);return e.r=c,e}function l(a,b,c,d,e){var f=i(Cb,e,a,b);return f.x2=c,f.y2=d,f}function m(a){for(var b=0;4>b;b++){var c=p(a);o(c,"x","y",b),c.shape==Cb&&o(c,"x2","y2",b),j(c),c.table=b}}function n(a){m(a),a.x=R-a.x,a.shape==Cb&&(a.x2=R-a.x2),a.mirror=!0,m(a)}function o(a,b,c,d){var e=a[b],f=a[c];if(0===d||2==d)e+=S+T,0===d&&(f=ab-f);else{var g=f;f=S+T+e,e=g,1==d&&(e=ab-e)}a[b]=e>>0,a[c]=f>>0}function p(a){return JSON.parse(JSON.stringify(a))}function q(a){return a}function r(a){return ab-a}function s(a,b,c){return b>a?b:a>c?c:a}function t(a,b){return O(a*a+b*b)}function u(a,b){b=(b||1)/t(a.x,a.y),a.x*=b,a.y*=b}function v(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.r+b.r;return e*e>c*c+d*d}function w(a,b,c){var d=a.x,e=a.y,f=a.r,g=b.x,h=b.y,i=b.x2,j=b.y2,k=i-g,l=j-h,m=M.sqrt(k*k+l*l),n=(i-g)/m,o=(j-h)/m,p=n*(d-g)+o*(e-h),q=p*n+g,r=p*o+h;if((i>g&&q>=g&&i>=q||g>i&&q>=i&&g>=q||g==i&&q==g)&&(j>h&&r>=h&&j>=r||h>j&&r>=j&&h>=r||h==j&&r==h)){var s=r-e,t=q-d,u=O(t*t+s*s);if(f>=u)return c.ex=q,c.ey=r,c.x=-t,c.y=-s,c.l=u,!0}return!1}function x(a,b,c,d,e){b==d?(a.vert=!0,a.x=b):(a.vert=!1,a.m=(c-e)/(b-d),a.p=c-a.m*b)}function y(a,b,c,d){return a.vert?b<a.x:d?b>(c-a.p)/a.m:c>a.m*b+a.p}function z(a,b){var c=K.createElement("canvas");return c.width=a,c.height=b,c}function A(a){return a.getContext("2d")}function B(a,b,c,d){0!==b&&(a.fillStyle=b),0!==c&&(a.strokeStyle=c),0!==d&&(a.lineWidth=d)}function C(a,b,c,d,e,f){f&&(f.width&&(f=a.createPattern(f,"repeat")),B(a,f)),a.fillRect(b,c,d,e)}function D(){var a=[].slice.call(arguments),b=a.shift();b.drawImage.apply(b,a)}function E(a,b,c,d,e,f,g){B(a,e,f,g||2),a.beginPath(),a.arc(b,c,d,0,2*N,!1),e&&a.fill(),f&&a.stroke(),a.closePath()}function F(a,b,c,d,e,f,g){B(a,0,f,g||2),a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke()}function G(a){a.clearRect(0,0,V,W)}function H(a,b){b||(b=window.e);var c=b.keyCode;b.charCode&&!c&&(c=b.charCode),Nb[Ub[c]]=a}function I(a,b){var c,d;"which"in b?(c=3==b.which,d=2==b.which):"button"in b&&(c=2==b.button,d=1==b.button),c?Ob.right=a:d?Ob.middle=a:Ob.left=a,Ob.x=b.clientX+Y,Ob.y=b.clientY+Z}var J=window,K=J.document,L=K.body,M=J.Math,N=M.PI,O=M.sqrt,P=M.random,Q=String.fromCharCode,R=700,S=200,T=200,U=T+R/2;U=t(U,U)-T>>0;var V,W,X,Y,Z,$,_,ab=R+2*S+2*T,bb=ab/2,cb=20,db=z(ab,ab),eb=A(db),fb=z(V,W),gb=A(fb),hb=z(V,W),ib=A(hb),jb=z(V,W),kb=A(jb);window.onresize=function(){V=s(J.innerWidth,R,ab),W=s(J.innerHeight,R,ab),X=M.min(V,W),jb.width=hb.width=fb.width=V-=V%2,jb.height=hb.height=fb.height=W-=W%2},L.onresize(),L.appendChild(fb);var lb,mb,nb,ob,pb,qb="#111",rb="#222",sb="#333",tb="#444",ub="#08e",vb="#000",wb="#0d0",xb="#dd0",yb="#000",zb="#fff",Ab="#fa0",Bb="c",Cb="l",Db="b",Eb="bg",Fb="bp",Gb="o",Hb="p",Ib="s",Jb=15,Kb=14,Lb=.2,Mb=.99,Nb={},Ob={},Pb=!1,Qb=0,Rb=100,Sb={},Tb={};E(ib,bb,bb,200,"red"),b(),g();var Ub={37:"left",38:"up",39:"right",40:"down",32:"space",27:"esc",82:"R",13:"Enter"};K.onkeyup=function(a){H(!1,a),27==a.keyCode&&(window._stopped?(window._stopped=!1,window.requestAnimationFrame=window._raf):(window._stopped=!0,window._raf=window.requestAnimationFrame,window.requestAnimationFrame=function(){})),13==a.keyCode&&window._stopped&&g()},K.onkeydown=function(a){H(!0,a)},K.onmousedown=function(a){I(!0,a)},K.onmouseup=function(a){I(!1,a)},K.onmousemove=function(a){Ob.x=a.clientX+Y,Ob.y=a.clientY+Z},K.oncontextmenu=function(){return!1}},function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();