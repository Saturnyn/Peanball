/*! pinball-em-up 02-09-2014 */
window.onload=function(){"use strict";function a(){function a(a,f){var g=4;Y.beginPath(),Y.strokeStyle=mb,Y.fillStyle=nb,Y.lineWidth=2,Y.moveTo(a(-g),f(-g)),Y.lineTo(a(P+Q),f(-g)),Y.lineTo(a(P+Q),f(P)),Y.arcTo(a(P+Q),f(P+Q),a(P),f(P+Q),Q),Y.lineTo(a(-g),f(P+Q)),Y.closePath(),Y.fill(),Y.stroke(),j(k(a(P),f(P),Q,vb)),j(l(a(0),f(P+Q),a(P),f(P+Q),vb)),j(l(a(P+Q),f(0),a(P+Q),f(P),vb)),Y.fillStyle=pb;var h=a==q?d:e;Y.fillText(N(h),a(P+Q+130)-2,f(50)-3),h=f==q?b:c,Y.fillText(N(h),a(50)-2,f(P+Q+130)-3)}B(_,0,0,W,W,jb),B(_,0,0,W-1,W-1,kb),B(_,0,0,W-2,W-2,ib),B(Y,0,0,V,V,$),E(Y,0,0,V,V,lb),E(Y,V,0,0,V,lb),D(Y,V/2,V/2,8,ib,lb);var b=8679,c=8681,d=8678,e=8680;Y.font="64px sans-serif",Y.textAlign="center",Y.textBaseline="middle",a(q,q),a(q,r),a(r,q),a(r,r)}function b(){Gb=0,Fb=!1,eb=[],fb=[],fb.n=0,a(),h()}function c(){if(!Fb){if(Db.space)Gb++;else if(Gb>0){var a=Gb/Hb;a>1&&(a=1),gb.boostX=3*(1+M()),gb.boostY=-zb,gb.boostCpt=10+50*a,Fb=!0}Db.R&&(Fb=!0)}Eb.right&&(Gb=0,Fb=!0,gb.x=Eb.x,gb.y=Eb.y,gb.a.x=gb.a.y=0,gb.v.x=gb.v.y=0,gb.boostCpt=0,Eb.right=!1,console.log("mouse teleport",gb));for(var b=0;b<hb.length;b++){var c,d=hb[b],e=!d.mirror;c=1==d.table?e?Db.up||Db.right:Db.down||Db.left:e?Db.up||Db.left:Db.down||Db.right;var f=d.ux,g=d.uy;d.cpt=d.cpt||0;var h=7;if(d.max=!1,c?d.cpt<h?d.cpt++:d.max=!0:d.cpt>0&&d.cpt--,d.prevX2=d.x2,d.prevY2=d.y2,d.movingUp=c&&!d.max,d.moving=0!==d.cpt,d.cpt>0){var i=d.amax*(d.cpt/h);d.mirror&&(i*=-1);var j=K.cos(i),k=K.sin(i);f=d.ux*j-d.uy*k,g=d.ux*k+d.uy*j}d._ux=f,d._uy=g,d.x2=d.x+f,d.y2=d.y+g}}function d(){if(Fb){gb.boostCpt>0&&(gb.boostCpt--,gb.a.x=gb.boostX,gb.a.y=gb.boostY);var a=0,b=0;if(!gb.noGrav){var c=gb.x-V/2,d=gb.y-V/2;d>c?d>-c?b=Bb:a=-Bb:d>-c?a=Bb:b=-Bb}gb.noGrav=!1,gb.a.x+=a,gb.a.y+=b,gb.v.x=gb.v.x+gb.a.x,gb.v.y=gb.v.y+gb.a.y,a?(gb.v.x*=Cb,gb.v.y*=Cb):(gb.v.x*=Cb,gb.v.y*=Cb),gb.v.x*gb.v.x+gb.v.y*gb.v.y>zb*zb&&u(gb.v,zb),gb.x+=gb.v.x,gb.y+=gb.v.y,console.log("===================================================================================="),console.log("loop","collided",gb.collide,"boost",gb.boostCpt),gb.collide=!1;for(var e=(gb.v.x,gb.v.y,0),f=eb.length;f>e;e++){var g=eb[e];if(g!=gb){g.collide=!1;var h,i=Jb;if(g.shape==sb)v(gb,g)&&(g.collide=!0,i.x=gb.x-g.x,Jb.y=gb.y-g.y,h=t(i.x,i.y),i.l=g.r+gb.r-h,i.x=i.x/h,i.y=i.y/h);else if(g.shape==tb){var j=g.kind==yb&&g.movingUp;if(!j&&w(gb,g,i)){g.collide=!0,x(Ib,g.x,g.y,g.x2,g.y2);var k=y(Ib,gb.x,gb.y)!==y(Ib,gb.prevX,gb.prevY);0>=k?h=gb.r-i.l:(h=gb.r+i.l,i.x*=-1,i.y*=-1),i.x/=i.l,i.y/=i.l,i.l=h}if(j){var l=w(gb,g,i),m=1==g.table||3==g.table;console.log("rising paddle",g,m?"REVERSE":"");var n,o;if(l?console.log(" paddle direct collision"):(x(Ib,g.x,g.y,g.prevX2,g.prevY2),n=y(Ib,gb.prevX,gb.prevY,m),console.log(" before",0,0,"and",g.prevX2-g.x,g.prevY2-g.y,n,"m",Ib.m,"p",Ib.p),console.log(" ball before:",gb.prevX-g.x,gb.prevY-g.y),x(Ib,g.x,g.y,g.x2,g.y2),o=y(Ib,gb.x,gb.y,m),console.log(" after",0,0,"and",g.x2-g.x,g.y2-g.y,o,"m",Ib.m,"p",Ib.p),console.log(" ball now:",gb.x-g.x,gb.y-g.y)),l||n!==o){l||console.log("  checking dotprod");var p=gb.x-g.x,q=gb.y-g.y,r=p*g._ux+q*g._uy;if((l||r>0)&&(l||p*p+q*q<g.l*g.l)){g.collide=!0;var s=(t(p,q),r/g.l);i.x=g.x+s*g._ux/g.l,i.y=g.y+s*g._uy/g.l,i.x=gb.x-i.x,i.y=gb.y-i.y,i.l=t(i.x,i.y),i.x/=i.l,i.y/=i.l;var z=g._uy/g.l,A=-g._ux/g.l;console.log("   NORMALE PAD",z,A,g),(g.mirror&&(0===g.table||3==g.table)||!g.mirror&&(1==g.table||2==g.table))&&(z*=-1,A*=-1);var B=z*i.x+A*i.y;0>B&&(i.x*=-1,i.y*=-1),i.l=i.l+gb.r,gb.x+=i.x*i.l,gb.y+=i.y*i.l,gb.collide=!0;var C=s/g.l;C=.2+(.3*C+.7*C*C);var D=20*C>>0,E=zb*C,F=i.x*E,G=i.y*E;gb.boostCpt?(gb.boostCpt+=D>2?2:D,gb.boostX=.2*F+.8*gb.boostX,gb.boostY=.2*G+.8*gb.boostY):(console.log("   INITIAL BOOST!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"),gb.boostCpt=D,gb.boostX=F,gb.boostY=G),gb.boostX*=.6+.8*M(),gb.boostY*=.6+.8*M(),console.log("   boosting",C,gb.boostCpt,gb.boostX,gb.boostY);continue}}}}if(g.collide){gb.x+=i.x*i.l,gb.y+=i.y*i.l,gb.collide=!0;var H=t(gb.v.x,gb.v.y),I=gb.v.x/H,J=gb.v.y/H,L=-i.y,N=i.x,O=L*I+N*J;0>O&&(L=-L,N=-N);var P=I*i.x+J*i.y;0>P&&(P=-P);var Q=K.sin(K.acos(P));0>Q&&(Q=-Q);var R=g.bounciness||.2;i.x*=P*R*H,i.y*=P*R*H,L*=Q*H,N*=Q*H,gb.v.x=i.x+L,gb.v.y=i.y+N}}}gb.a.x=gb.a.y=0,gb.prevX=gb.x,gb.prevY=gb.y,gb.x+Ab<0?Fb=!1:gb.x-Ab>V?Fb=!1:gb.y+Ab<0?Fb=!1:gb.y-Ab>V&&(Fb=!1)}}function e(){var a=gb.x,b=gb.y,c=a-V/2,d=b-V/2,e=c,f=d;0>e&&(e*=-1),0>f&&(f*=-1);var g=O/2+Q;if(g>e&&g>f){var h=e-g,i=f-g,j=h*h+i*i;if(g*g>j){var k=L(j);h=h*g/k,i=i*g/k,a=h+g,b=i+g,0>c&&(a=-a),0>d&&(b=-b),a=V/2+a,b=V/2+b}}else f>e?a=V/2:b=V/2;a=s(a,gb.x-.3*S,gb.x+.3*S),b=s(b,gb.y-.3*T,gb.y+.3*T),a=s(a-S/2,0,V-S),b=s(b-T/2,0,V-T),Fb?(cb+=.3*(a-cb),db+=.3*(b-db)):(cb=a,db=b)}function f(){bb.clearRect(0,0,S,T),D(Y,gb.x,gb.y,1,gb.collide?"red":gb.boostCpt>0?"orange":"white"),D(Y,cb+S/2,db+T/2,1,lb),C(bb,X,-cb,-db);for(var a=0,b=eb.length;b>a;a++){var c,d,e,f=eb[a],g=f.x-cb,h=f.y-db;if(f.shape==sb){if(f==gb){if(d=qb,c=rb,Gb>0&&!Fb){var i=4*s(Gb/Hb,0,1)>>0;g+=i*M()>>0,h+=i*M()>>0,4==i&&(d="#f00")}}else f.kind==vb?(c=0,d=0):(e=2,d=mb,c="#000",f.collide&&(d=ob));(c||d)&&D(bb,g,h,f.r,c,d,e)}else f.shape==tb&&(f.kind==vb?(c=0,d=0):(d=mb,f.kind==yb&&(d=pb,f.collide&&(d=ob))),(c||d)&&E(bb,f.x-cb,f.y-db,f.x2-cb,f.y2-db,d,2))}E(bb,gb.x-cb,gb.y-db,gb.x-cb+10*gb.v.x,gb.y-db+10*gb.v.y,"#0f0")}function g(){c(),d(),e(),f(),window.requestAnimationFrame(g)}function h(){gb=j(k(V/2,V-50,Ab,ub)),n(k(60,250,30,wb)),n(l(0,200,150,100,xb)),n(l(150,100,270,50,yb)),hb=eb.slice(-8);for(var a=hb[0],b=t(a.x-a.x2,a.y-a.y2),c=2*-K.acos((a.x2-a.x)/b),d=0;d<hb.length;d++)a=hb[d],a.l=b,a.ux=a.x2-a.x,a.uy=a.y2-a.y,a.amax=c,(1==a.table||2==a.table)&&(a.amax*=-1)}function i(a,b,c,d){return{x:c||0,y:d||0,shape:a,kind:b,v:{x:0,y:0},a:{x:0,y:0}}}function j(a){return eb.push(a),a}function k(a,b,c,d){var e=i(sb,d,a,b);return e.r=c,e}function l(a,b,c,d,e){var f=i(tb,e,a,b);return f.x2=c,f.y2=d,f}function m(a){for(var b=0;4>b;b++){var c=p(a);o(c,"x","y",b),c.shape==tb&&o(c,"x2","y2",b),j(c),c.table=b}}function n(a){m(a),a.x=O-a.x,a.shape==tb&&(a.x2=O-a.x2),a.mirror=!0,m(a)}function o(a,b,c,d){var e=a[b],f=a[c];if(0===d||2==d)e+=P+Q,0===d&&(f=V-f);else{var g=f;f=P+Q+e,e=g,1==d&&(e=V-e)}a[b]=e>>0,a[c]=f>>0}function p(a){return JSON.parse(JSON.stringify(a))}function q(a){return a}function r(a){return V-a}function s(a,b,c){return b>a?b:a>c?c:a}function t(a,b){return L(a*a+b*b)}function u(a,b){b=(b||1)/t(a.x,a.y),a.x*=b,a.y*=b}function v(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.r+b.r;return e*e>c*c+d*d}function w(a,b,c){var d=a.x,e=a.y,f=a.r,g=b.x,h=b.y,i=b.x2,j=b.y2,k=i-g,l=j-h,m=K.sqrt(k*k+l*l),n=(i-g)/m,o=(j-h)/m,p=n*(d-g)+o*(e-h),q=p*n+g,r=p*o+h;if((i>g&&q>=g&&i>=q||g>i&&q>=i&&g>=q||g==i&&q==g)&&(j>h&&r>=h&&j>=r||h>j&&r>=j&&h>=r||h==j&&r==h)){var s=r-e,t=q-d,u=L(t*t+s*s);if(f>=u)return c.ex=q,c.ey=r,c.x=-t,c.y=-s,c.l=u,!0}return!1}function x(a,b,c,d,e){b==d?(a.vert=!0,a.x=b):(a.vert=!1,a.m=(c-e)/(b-d),a.p=c-a.m*b)}function y(a,b,c,d){return a.vert?b<a.x:d?b>(c-a.p)/a.m:c>a.m*b+a.p}function z(a,b){var c=I.createElement("canvas");return c.width=a,c.height=b,c}function A(a){return a.getContext("2d")}function B(a,b,c,d,e,f){f&&(a.fillStyle=f.width?a.createPattern(f,"repeat"):f),a.fillRect(b,c,d,e)}function C(){var a=[].slice.call(arguments),b=a.shift();b.drawImage.apply(b,a)}function D(a,b,c,d,e,f,g){a.beginPath(),a.arc(b,c,d,0,2*K.PI,!1),e&&(a.fillStyle=e,a.fill()),f&&(a.lineWidth=g||2,a.strokeStyle=f,a.stroke())}function E(a,b,c,d,e,f,g){g&&(a.lineWidth=g),f&&(a.strokeStyle=f),a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke()}function F(a,b){b||(b=window.e);var c=b.keyCode;b.charCode&&!c&&(c=b.charCode),Db[Kb[c]]=a}function G(a,b){var c;"which"in b?c=3==b.which:"button"in b&&(c=2==b.button),c?(Eb.right=a,Eb.rightCpt=0):(Eb.left=a,Eb.leftCpt=0),Eb.x=b.clientX+cb,Eb.y=b.clientY+db}var H=window,I=H.document,J=I.body,K=H.Math,L=K.sqrt,M=(L(2),K.random),N=String.fromCharCode,O=600,P=200,Q=300,R=Q+O/2;R=t(R,R)-Q>>0;var S,T,U,V=O+2*P+2*Q,W=20,X=z(V,V),Y=A(X),Z=z(V,V),$=(A(Z),z(W,W)),_=A($),ab=z(S,T),bb=A(ab),cb=0,db=0;window.onresize=function(){S=s(H.innerWidth,O,V),T=s(H.innerHeight,O,V),U=K.min(S,T),ab.width=S-=S%2,ab.height=T-=T%2},J.onresize(),J.appendChild(ab);var eb,fb,gb,hb,ib="#111",jb="#222",kb="#333",lb="#444",mb="#08e",nb="#000",ob="#0d0",pb="#dd0",qb="#000",rb="#fff",sb="c",tb="l",ub="b",vb="bg",wb="bp",xb="o",yb="p",zb=15,Ab=14,Bb=.2,Cb=.99,Db={},Eb={},Fb=!1,Gb=0,Hb=100,Ib={},Jb={};b(),g();var Kb={37:"left",38:"up",39:"right",40:"down",32:"space",27:"esc",82:"R",13:"Enter"};I.onkeyup=function(a){F(!1,a),27==a.keyCode&&(window._stopped?(window._stopped=!1,window.requestAnimationFrame=window._raf):(window._stopped=!0,window._raf=window.requestAnimationFrame,window.requestAnimationFrame=function(){})),13==a.keyCode&&window._stopped&&g()},I.onkeydown=function(a){F(!0,a)},I.onmousedown=function(a){G(!1,a)},I.onmouseup=function(a){G(!0,a)},I.oncontextmenu=function(){return!1}},function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();