/*! pinball-em-up 06-09-2014 */
window.onload=function(){"use strict";function a(){function a(a,b){var c=4;C(hb,Bb,Ab,2),hb.beginPath(),hb.moveTo(a(-c),b(-c)),hb.lineTo(a(V+W),b(-c)),hb.lineTo(a(V+W),b(V)),hb.arcTo(a(V+W),b(V+W),a(V),b(V+W),W),hb.lineTo(a(-c),b(V+W)),hb.closePath(),hb.fill(),hb.stroke(),k(l(a(V),b(V),W,Mb)),k(m(a(0),b(V+W),a(V),b(V+W),Mb)),k(m(a(V+W),b(0),a(V+W),b(V),Mb)),C(hb,Db);var d=a==r?o:p;hb.fillText(R(d),a(V+W+130)-2,b(50)-3),d=b==r?j:n,hb.fillText(R(d),a(50)-2,b(V+W+130)-3)}var b=A(fb,fb),c=B(b);D(c,0,0,fb,fb,xb),D(c,0,0,fb-1,fb-1,yb),D(c,0,0,fb-2,fb-2,wb),D(hb,0,0,db,db,b);for(var d=0;4>d;d++){var e,f=0,g=0,h=db,i=db;D(c,0,0,b.width,b.height,wb),c.beginPath(),0===d?(g=db-V,i=V,C(c,0,"#358",2),c.moveTo(0,fb/2),c.quadraticCurveTo(fb/4,fb/4,fb/2,fb/2),c.quadraticCurveTo(3*fb/4,3*fb/4,fb,fb/2),c.stroke()):1==d?(f=db-V-2,h=V):2==d?(i=V,e="#421"):(h=V,e="#def"),D(hb,f,g,h,i,b),c.globalAlpha=1}G(hb,0,0,db,db,zb),G(hb,db,0,0,db,zb),F(hb,eb,eb,8,wb,zb);var j=8679,n=8681,o=8678,p=8680;hb.font="64px sans-serif",hb.textAlign="center",hb.textBaseline="middle",a(r,r),a(r,s),a(s,r),a(s,s);var q=Ib,t=q/2;pb.translate(4,4),C(pb,"#aef","#5af",2),pb.beginPath(),pb.moveTo(t,0),pb.quadraticCurveTo(q,-3,q,t),pb.quadraticCurveTo(q,q+1,t,q-2),pb.quadraticCurveTo(2,q,0,t),pb.quadraticCurveTo(-3,-1,t,0),pb.fill(),pb.stroke(),G(pb,8,4,4,20,"#fff",2),G(pb,16,2,8,26,0,1),G(pb,36,14,18,36,0,1),G(pb,38,18,26,36,0,2),G(pb,t-4,10,t-4,18,"#58f",2),G(pb,t+4,10,t+4,18),pb.translate(q+8,0),C(pb,"#fa0","#f00",2),pb.beginPath(),pb.moveTo(t,-4),pb.lineTo(t+6,14),pb.lineTo(q-4,8),pb.quadraticCurveTo(q,q+3,t,q-2),pb.quadraticCurveTo(2,q,4,8),pb.lineTo(t-6,14),pb.lineTo(t,-4),pb.fill(),pb.stroke(),G(pb,t-3,26,t-8,20),G(pb,t+3,26,t+8,20),pb.translate(q+8,0),C(pb,"#fd7","#d72",2),pb.beginPath(),pb.moveTo(t,0),pb.quadraticCurveTo(q,10,q-8,q-8),pb.quadraticCurveTo(q,q+1,t+2,q-6),pb.quadraticCurveTo(14,q-12,2,q-4),pb.quadraticCurveTo(-2,q-10,4,t),pb.quadraticCurveTo(0,0,t,0),pb.fill(),pb.stroke(),F(pb,10,7,1,"#d72"),F(pb,24,9,1,"#d72"),F(pb,7,20,1,"#d72"),F(pb,20,14,1,"#d72"),F(pb,8,30,1,"#d72"),F(pb,28,32,1,"#d72"),pb.scale(1,1.5),F(pb,13,14,4,"#111","#d72",1),pb.scale(1,2/3),pb.stroke(),pb.scale(1,1.5),F(pb,26,14,4,"#111","#d72",1),pb.scale(1,2/3),pb.stroke(),pb.translate(q+8,0),pb.lineCap="round",C(pb,0,"red",4),pb.beginPath(),pb.arc(t,t-2,t,.6,2.54),pb.stroke(),pb.beginPath(),pb.arc(t,t-10,t+5,1,2.14),pb.stroke(),F(pb,t,t,t-4,"rgba(255,255,255,0.1)","#fff",2),C(0,0,1),pb.beginPath(),pb.arc(t,t,t-8,3.2,4.4),pb.stroke(),F(pb,t-4,t+4,4,0,"#fff",2),F(pb,t+4,t+4,4,0,"#fff",2)}function b(){Zb=0,Yb=!1,qb=[],rb=[],sb=[],sb.n=0,rb.n=0,a(),i()}function c(){if(!Yb){if(Wb.space)Zb++;else if(Zb>0){var a=Zb/$b;a>1&&(a=1),tb.boostX=3*(1+Q()),tb.boostY=-Sb,tb.boostCpt=10+50*a,Yb=!0}Wb.R&&(Yb=!0)}for(var b=0;b<ub.length;b++){var c,d=ub[b],e=!d.mirror;c=1==d.table?e?Wb.up||Wb.right:Wb.down||Wb.left:e?Wb.up||Wb.left:Wb.down||Wb.right;var f=d.ux,g=d.uy;d.cpt=d.cpt||0;var h=7;if(d.max=!1,c?d.cpt<h?d.cpt++:d.max=!0:d.cpt>0&&d.cpt--,d.prevX2=d.x2,d.prevY2=d.y2,d.movingUp=c&&!d.max,d.moving=0!==d.cpt,d.cpt>0){var i=d.amax*(d.cpt/h);d.mirror&&(i*=-1);var k=N.cos(i),l=N.sin(i);f=d.ux*k-d.uy*l,g=d.ux*l+d.uy*k}d._ux=f,d._uy=g,d.x2=d.x+f,d.y2=d.y+g}if(Xb.middle&&(Zb=0,Yb=!0,tb.x=Xb.x,tb.y=Xb.y,tb.a.x=tb.a.y=0,tb.v.x=tb.v.y=0,tb.boostCpt=0,Xb.right=!1,console.log("mouse teleport",tb)),Xb.right&&(ac.x=Xb.x-tb.x,ac.y=Xb.y-tb.y,v(ac),tb.boostCpt=6,tb.boostX=2.5*ac.x,tb.boostY=2.5*ac.y,Xb.right=!1),Xb.left&&(ac.x=Xb.x-tb.x,ac.y=Xb.y-tb.y,v(ac),Xb.leftCpt%10===0)){var m;rb.length==rb.n?(m=j(Kb,Qb),rb.push(m)):m=rb[rb.n],rb.n++;var n=10;m.x=tb.x+ac.x*(n+Tb),m.y=tb.y+ac.y*(n+Tb),m.v.x=ac.x*n,m.v.y=ac.y*n,m.cpt=100}Xb.left?Xb.leftCpt++:Xb.leftCpt=0}function d(){var a,b,c;for(a=0,b=vb.length;b>a;a++)c=vb[a],c.a=c.a+c.da,c.x=eb+N.cos(c.a)*c.d,c.y=eb+N.sin(c.a)*c.d;if(Yb){tb.boostCpt>0&&(tb.boostCpt--,tb.a.x=tb.boostX,tb.a.y=tb.boostY);var d=0,e=0,f=Ub;t=eb-tb.x,A=eb-tb.y;var g=Y/2,h=u(t,A);g>h&&(t/=h,A/=h,f*=.1+.9*h/g);var i=tb.x-eb,j=tb.y-eb;j>i?j>-i?e=f:d=-f:j>-i?d=f:e=-f,tb.a.x+=d,tb.a.y+=e,tb.v.x=tb.v.x+tb.a.x,tb.v.y=tb.v.y+tb.a.y,tb.v.x*=Vb,tb.v.y*=Vb,tb.v.x*tb.v.x+tb.v.y*tb.v.y>Sb*Sb&&v(tb.v,Sb),tb.x+=tb.v.x,tb.y+=tb.v.y,tb.collide=!1;var k=(tb.v.x,tb.v.y,qb.length);for(b=k+sb.n,a=0;b>a;a++)if(c=k>a?qb[a]:sb[a-k],c!=tb){c.collide=!1;var l,m=ac;if(c.shape==Jb){if(c.kind==Rb&&(c.elt==S||c.dead))continue;w(tb,c)&&(c.collide=!0,m.x=tb.x-c.x,ac.y=tb.y-c.y,l=u(m.x,m.y),m.l=c.r+tb.r-l,m.x=m.x/l,m.y=m.y/l)}else if(c.shape==Kb){var n=c.kind==Pb&&c.movingUp;if(!n&&x(tb,c,m)){c.collide=!0,y(_b,c.x,c.y,c.x2,c.y2);var o=z(_b,tb.x,tb.y)!==z(_b,tb.prevX,tb.prevY);0>=o?l=tb.r-m.l:(l=tb.r+m.l,m.x*=-1,m.y*=-1),m.x/=m.l,m.y/=m.l,m.l=l}if(n){var p=x(tb,c,m),q=1==c.table||3==c.table;console.log("rising paddle",c,q?"REVERSE":"");var r,s;if(p?console.log(" paddle direct collision"):(y(_b,c.x,c.y,c.prevX2,c.prevY2),r=z(_b,tb.prevX,tb.prevY,q),console.log(" before",0,0,"and",c.prevX2-c.x,c.prevY2-c.y,r,"m",_b.m,"p",_b.p),console.log(" ball before:",tb.prevX-c.x,tb.prevY-c.y),y(_b,c.x,c.y,c.x2,c.y2),s=z(_b,tb.x,tb.y,q),console.log(" after",0,0,"and",c.x2-c.x,c.y2-c.y,s,"m",_b.m,"p",_b.p),console.log(" ball now:",tb.x-c.x,tb.y-c.y)),p||r!==s){p||console.log("  checking dotprod");var t=tb.x-c.x,A=tb.y-c.y,B=t*c._ux+A*c._uy;if((p||B>0)&&(p||t*t+A*A<c.l*c.l)){c.collide=!0;var C=(u(t,A),B/c.l);m.x=c.x+C*c._ux/c.l,m.y=c.y+C*c._uy/c.l,m.x=tb.x-m.x,m.y=tb.y-m.y,m.l=u(m.x,m.y),m.x/=m.l,m.y/=m.l;var D=c._uy/c.l,E=-c._ux/c.l;console.log("   NORMALE PAD",D,E,c),(c.mirror&&(0===c.table||3==c.table)||!c.mirror&&(1==c.table||2==c.table))&&(D*=-1,E*=-1);var F=D*m.x+E*m.y;0>F&&(m.x*=-1,m.y*=-1),m.l=m.l+tb.r,tb.x+=m.x*m.l,tb.y+=m.y*m.l,tb.collide=!0;var G=C/c.l;G=.2+(.3*G+.7*G*G);var H=20*G>>0,I=Sb*G,J=m.x*I,K=m.y*I;tb.boostCpt?(tb.boostCpt+=H>2?2:H,tb.boostX=.2*J+.8*tb.boostX,tb.boostY=.2*K+.8*tb.boostY):(tb.boostCpt=H,tb.boostX=J,tb.boostY=K),tb.boostX*=.6+.8*Q(),tb.boostY*=.6+.8*Q(),console.log("   boosting",G,tb.boostCpt,tb.boostX,tb.boostY);continue}}}}if(c.collide){c.colCpt=20,tb.x+=m.x*m.l,tb.y+=m.y*m.l,tb.collide=!0;var L=u(tb.v.x,tb.v.y),M=tb.v.x/L,O=tb.v.y/L,P=-m.y,R=m.x,U=P*M+R*O;0>U&&(P=-P,R=-R);var V=M*m.x+O*m.y;0>V&&(V=-V);var W=N.sin(N.acos(V));0>W&&(W=-W);var X=c.kind==Nb||"elt"in c&&c.elt!=T?1.5:.2;m.x*=V*X*L,m.y*=V*X*L,P*=W*L,R*=W*L,tb.v.x=m.x+P,tb.v.y=m.y+R}}tb.a.x=tb.a.y=0,tb.prevX=tb.x,tb.prevY=tb.y,tb.x+Tb<0?Yb=!1:tb.x-Tb>db?Yb=!1:tb.y+Tb<0?Yb=!1:tb.y-Tb>db&&(Yb=!1)}var Z;for(a=0,b=rb.n;b>a;a++)Z=rb[a],Z.cpt--,Z.cpt>0&&(Z.x+=Z.v.x,Z.y+=Z.v.y);for(a=0;a<rb.n;a++)Z=rb[a],0===Z.cpt&&(rb[a]=rb[rb.n-1],rb[rb.n-1]=Z,rb.n--,a--)}function e(){bb=_,cb=ab;var a=tb.x,b=tb.y,c=a-eb,d=b-eb,e=c,f=d;0>e&&(e*=-1),0>f&&(f*=-1);var g=U/2+W;if(g>e&&g>f){var h=e-g,i=f-g,j=h*h+i*i;if(g*g>j){var k=P(j);h=h*g/k,i=i*g/k,a=h+g,b=i+g,0>c&&(a=-a),0>d&&(b=-b),a=eb+a,b=eb+b}}else f>e?a=eb:b=eb;a=t(a,tb.x-.3*Y,tb.x+.3*Y),b=t(b,tb.y-.3*Z,tb.y+.3*Z),a=t(a-Y/2,0,db-Y),b=t(b-Z/2,0,db-Z),Yb?(_+=.3*(a-_),ab+=.3*(b-ab)):(_=a,ab=b)}function f(){H(jb),H(nb),E(jb,kb,0,0),lb.clearRect(0,0,Y,Z),lb.save(),lb.globalAlpha=.9,E(lb,ib,-_+bb,-ab+cb),lb.restore(),H(jb),tb.boostCpt>0?(F(lb,tb.x-_,tb.y-ab,6,"orange"),F(lb,tb.prevX-_,tb.prevY-ab,6,"orange")):F(lb,tb.x-_,tb.y-ab,2,"white");for(var a=0,b=qb.length;b>a;a++){var c,d,e,f=qb[a],g=f.x-_,h=f.y-ab;if(f==tb){if(Zb>0&&!Yb){var i=4*t(Zb/$b,0,1)>>0;g+=i*Q()>>0,h+=i*Q()>>0,4==i&&(d="#f00")}var j=N.atan2(tb.v.y,tb.v.x);tb.cpt=++tb.cpt%20;var k=tb.cpt;k>10&&(k=20-k),0===k?F(nb,tb.x-_,tb.y-ab,Tb,Fb,Eb):(C(nb,Fb,Eb,2),k*=.3*O/10,nb.beginPath(),nb.arc(tb.x-_,tb.y-ab,tb.r,j+k,j-k),nb.lineTo(tb.x-_,tb.y-ab),nb.closePath(),nb.fill(),nb.stroke())}else f.shape==Jb?(f.kind==Mb?(c=0,d=0):(e=2,d=Ab,c="#000",f.colCpt>0&&(f.colCpt--,d=Cb)),(c||d)&&F(nb,g,h,f.r,c,d,e)):f.shape==Kb&&(f.kind==Mb?d=0:(d=Ab,f.kind==Pb&&(d=Db,f.collide&&(d=Cb))),d&&G(nb,f.x-_,f.y-ab,f.x2-_,f.y2-ab,d,2))}for(a=0,b=sb.n;b>a;a++){var l=1,m=sb[a],n=Ib+2*Hb;if(m.dead){if(m.cpt--,0===m.cpt){l=sb[sb.n-1],sb[a]=l,sb[sb.n-1]=m,sb.n--,a--;continue}l=m.cpt/50}else m.cpt<50&&(m.cpt++,l=m.cpt/50);nb.globalAlpha=l,E(nb,ob,m.elt*n,0,n,n,m.x-n/2-_,m.y-n/2-ab,n,n)}nb.globalAlpha=1;var o;for(a=0,b=rb.n;b>a;a++)o=rb[a],F(nb,o.x-_,o.y-ab,4,Gb),G(lb,o.x-_,o.y-ab,o.x-o.v.x-_,o.y-o.v.y-ab,Gb,2);E(jb,gb,-_,-ab),E(jb,kb,0,0),E(jb,mb,0,0)}function g(){for(var a=6;sb.n<a;){var b;sb.length==sb.n?(b=j(Jb,Rb),sb.push(b),b.elt=sb.n%4,b.r=Ib/2-4):b=sb[sb.n],sb.n++;var c=vb[sb.n%vb.length];b.x=c.x,b.y=c.y,b.cpt=0,b.dead=0}}function h(){c(),d(),e(),f(),g(),window.requestAnimationFrame(h)}function i(){tb=k(l(eb,db-50,Tb,Lb)),tb.cpt=0,o(m(0,220,150,100,Ob)),vb=[];for(var a=10,b=0;a>b;b++){var c=20+30*Q(),d=80+c+(X-2*c-80)*b/a>>0,e=2*Q()*O,f=l(0,0,c,Nb);vb.push(k(f));var g=.2+.2*Q()*(Q()>.5?-1:1);f.da=g/d,f.a=e,f.d=d,console.log(f.da)}o(m(150,100,300,30,Pb)),ub=qb.slice(-8);var h=ub[0],i=u(h.x-h.x2,h.y-h.y2),j=2*-N.acos((h.x2-h.x)/i);for(b=0;b<ub.length;b++)h=ub[b],h.l=i,h.ux=h.x2-h.x,h.uy=h.y2-h.y,h.amax=j,(1==h.table||2==h.table)&&(h.amax*=-1)}function j(a,b,c,d){return{x:c||0,y:d||0,shape:a,kind:b,v:{x:0,y:0},a:{x:0,y:0}}}function k(a){return qb.push(a),a}function l(a,b,c,d){var e=j(Jb,d,a,b);return e.r=c,e}function m(a,b,c,d,e){var f=j(Kb,e,a,b);return f.x2=c,f.y2=d,f}function n(a){for(var b=0;4>b;b++){var c=q(a);p(c,"x","y",b),c.shape==Kb&&p(c,"x2","y2",b),k(c),c.table=b}}function o(a){n(a),a.x=U-a.x,a.shape==Kb&&(a.x2=U-a.x2),a.mirror=!0,n(a)}function p(a,b,c,d){var e=a[b],f=a[c];if(0===d||2==d)e+=V+W,0===d&&(f=db-f);else{var g=f;f=V+W+e,e=g,1==d&&(e=db-e)}a[b]=e>>0,a[c]=f>>0}function q(a){return JSON.parse(JSON.stringify(a))}function r(a){return a}function s(a){return db-a}function t(a,b,c){return b>a?b:a>c?c:a}function u(a,b){return P(a*a+b*b)}function v(a,b){b=(b||1)/u(a.x,a.y),a.x*=b,a.y*=b}function w(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.r+b.r;return e*e>c*c+d*d}function x(a,b,c){var d=a.x,e=a.y,f=a.r,g=b.x,h=b.y,i=b.x2,j=b.y2,k=i-g,l=j-h,m=N.sqrt(k*k+l*l),n=(i-g)/m,o=(j-h)/m,p=n*(d-g)+o*(e-h),q=p*n+g,r=p*o+h;if((i>g&&q>=g&&i>=q||g>i&&q>=i&&g>=q||g==i&&q==g)&&(j>h&&r>=h&&j>=r||h>j&&r>=j&&h>=r||h==j&&r==h)){var s=r-e,t=q-d,u=P(t*t+s*s);if(f>=u)return c.ex=q,c.ey=r,c.x=-t,c.y=-s,c.l=u,!0}return!1}function y(a,b,c,d,e){b==d?(a.vert=!0,a.x=b):(a.vert=!1,a.m=(c-e)/(b-d),a.p=c-a.m*b)}function z(a,b,c,d){return a.vert?b<a.x:d?b>(c-a.p)/a.m:c>a.m*b+a.p}function A(a,b){var c=L.createElement("canvas");return c.width=a,c.height=b,c}function B(a){return a.getContext("2d")}function C(a,b,c,d){0!==b&&(a.fillStyle=b),0!==c&&(a.strokeStyle=c),0!==d&&(a.lineWidth=d)}function D(a,b,c,d,e,f){f&&(f.width&&(f=a.createPattern(f,"repeat")),C(a,f)),a.fillRect(b,c,d,e)}function E(){var a=[].slice.call(arguments),b=a.shift();b.drawImage.apply(b,a)}function F(a,b,c,d,e,f,g){C(a,e,f,g||2),a.beginPath(),a.arc(b,c,d,0,2*O,!1),e&&a.fill(),f&&a.stroke(),a.closePath()}function G(a,b,c,d,e,f,g){C(a,0,f,g||2),a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke()}function H(a){a.clearRect(0,0,Y,Z)}function I(a,b){b||(b=window.e);var c=b.keyCode;b.charCode&&!c&&(c=b.charCode),Wb[bc[c]]=a}function J(a,b){var c,d;"which"in b?(c=3==b.which,d=2==b.which):"button"in b&&(c=2==b.button,d=1==b.button),c?Xb.right=a:d?Xb.middle=a:Xb.left=a,Xb.x=b.clientX+_,Xb.y=b.clientY+ab}var K=window,L=K.document,M=L.body,N=K.Math,O=N.PI,P=N.sqrt,Q=N.random,R=String.fromCharCode,S=1,T=2,U=700,V=220,W=200,X=W+U/2;X=u(X,X)-W>>0;var Y,Z,$,_,ab,bb,cb,db=U+2*V+2*W,eb=db/2,fb=20,gb=A(db,db),hb=B(gb),ib=A(Y,Z),jb=B(ib),kb=A(Y,Z),lb=B(kb),mb=A(Y,Z),nb=B(mb),ob=A(400,100),pb=B(ob);window.onresize=function(){Y=t(K.innerWidth,U,db),Z=t(K.innerHeight,U,db),$=N.min(Y,Z),mb.width=kb.width=ib.width=Y-=Y%2,mb.height=kb.height=ib.height=Z-=Z%2},M.onresize(),M.appendChild(ib);var qb,rb,sb,tb,ub,vb,wb="#111",xb="#222",yb="#333",zb="#444",Ab="#08e",Bb="#000",Cb="#0d0",Db="#dd0",Eb="#000",Fb="#fff",Gb="#fa0",Hb=4,Ib=40,Jb="c",Kb="l",Lb="b",Mb="bg",Nb="bp",Ob="o",Pb="p",Qb="s",Rb="m",Sb=15,Tb=14,Ub=.2,Vb=.99,Wb={},Xb={},Yb=!1,Zb=0,$b=100,_b={},ac={};b(),h();var bc={37:"left",38:"up",39:"right",40:"down",32:"space",27:"esc",82:"R",13:"Enter"};L.onkeyup=function(a){I(!1,a),27==a.keyCode&&(window._stopped?(window._stopped=!1,window.requestAnimationFrame=window._raf):(window._stopped=!0,window._raf=window.requestAnimationFrame,window.requestAnimationFrame=function(){})),13==a.keyCode&&window._stopped&&h()},L.onkeydown=function(a){I(!0,a)},L.onmousedown=function(a){J(!0,a)},L.onmouseup=function(a){J(!1,a)},L.onmousemove=function(a){Xb.x=a.clientX+_,Xb.y=a.clientY+ab},L.oncontextmenu=function(){return!1}},function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();