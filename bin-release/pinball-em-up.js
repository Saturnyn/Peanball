/*! pinball-em-up 03-09-2014 */
window.onload=function(){"use strict";function a(){function a(a,f){var g=4;Y.beginPath(),Y.strokeStyle=mb,Y.fillStyle=nb,Y.lineWidth=2,Y.moveTo(a(-g),f(-g)),Y.lineTo(a(P+Q),f(-g)),Y.lineTo(a(P+Q),f(P)),Y.arcTo(a(P+Q),f(P+Q),a(P),f(P+Q),Q),Y.lineTo(a(-g),f(P+Q)),Y.closePath(),Y.fill(),Y.stroke(),j(k(a(P),f(P),Q,wb)),j(l(a(0),f(P+Q),a(P),f(P+Q),wb)),j(l(a(P+Q),f(0),a(P+Q),f(P),wb)),Y.fillStyle=pb;var h=a==q?d:e;Y.fillText(N(h),a(P+Q+130)-2,f(50)-3),h=f==q?b:c,Y.fillText(N(h),a(50)-2,f(P+Q+130)-3)}B(_,0,0,W,W,jb),B(_,0,0,W-1,W-1,kb),B(_,0,0,W-2,W-2,ib),B(Y,0,0,V,V,$),E(Y,0,0,V,V,lb),E(Y,V,0,0,V,lb),D(Y,V/2,V/2,8,ib,lb);var b=8679,c=8681,d=8678,e=8680;Y.font="64px sans-serif",Y.textAlign="center",Y.textBaseline="middle",a(q,q),a(q,r),a(r,q),a(r,r)}function b(){Ib=0,Hb=!1,eb=[],fb=[],fb.n=0,a(),h()}function c(){if(!Hb){if(Fb.space)Ib++;else if(Ib>0){var a=Ib/Jb;a>1&&(a=1),gb.boostX=3*(1+M()),gb.boostY=-Bb,gb.boostCpt=10+50*a,Hb=!0}Fb.R&&(Hb=!0)}if(Gb.right&&(Ib=0,Hb=!0,gb.x=Gb.x,gb.y=Gb.y,gb.a.x=gb.a.y=0,gb.v.x=gb.v.y=0,gb.boostCpt=0,Gb.right=!1,console.log("mouse teleport",gb)),Gb.left&&(Lb.x=Gb.x-gb.x,Lb.y=Gb.y-gb.y,u(Lb),gb.a.x=Lb.x*Db,gb.a.y=Lb.y*Db,Gb.leftCpt%10===0)){var b;fb.length==fb.n?(b=i(ub,Ab),fb.push(b)):b=fb[fb.n],fb.n++;var c=20;b.x=gb.x+Lb.x*(c+Cb),b.y=gb.y+Lb.y*(c+Cb),b.v.x=Lb.x*c,b.v.y=Lb.y*c,b.cpt=15}Gb.left?Gb.leftCpt++:Gb.leftCpt=0;for(var d=0;d<hb.length;d++){var e,f=hb[d],g=!f.mirror;e=1==f.table?g?Fb.up||Fb.right:Fb.down||Fb.left:g?Fb.up||Fb.left:Fb.down||Fb.right;var h=f.ux,j=f.uy;f.cpt=f.cpt||0;var k=7;if(f.max=!1,e?f.cpt<k?f.cpt++:f.max=!0:f.cpt>0&&f.cpt--,f.prevX2=f.x2,f.prevY2=f.y2,f.movingUp=e&&!f.max,f.moving=0!==f.cpt,f.cpt>0){var l=f.amax*(f.cpt/k);f.mirror&&(l*=-1);var m=K.cos(l),n=K.sin(l);h=f.ux*m-f.uy*n,j=f.ux*n+f.uy*m}f._ux=h,f._uy=j,f.x2=f.x+h,f.y2=f.y+j}}function d(){var a,b;if(Hb){gb.boostCpt>0&&(gb.boostCpt--,gb.a.x=gb.boostX,gb.a.y=gb.boostY);var c=0,d=0,e=Db;r=V/2-gb.x,s=V/2-gb.y;var f=S/2;if(f*f>r*r+s*s&&(j=t(r,s),r/=j,s/=j,e*=.2+.8*j/f),!gb.noGrav){var g=gb.x-V/2,h=gb.y-V/2;h>g?h>-g?d=e:c=-e:h>-g?c=e:d=-e}gb.noGrav=!1,gb.a.x+=c,gb.a.y+=d,gb.v.x=gb.v.x+gb.a.x,gb.v.y=gb.v.y+gb.a.y,c?(gb.v.x*=Eb,gb.v.y*=Eb):(gb.v.x*=Eb,gb.v.y*=Eb),gb.v.x*gb.v.x+gb.v.y*gb.v.y>Bb*Bb&&u(gb.v,Bb),gb.x+=gb.v.x,gb.y+=gb.v.y,gb.collide=!1;{gb.v.x,gb.v.y}for(a=0,b=eb.length;b>a;a++){var i=eb[a];if(i!=gb){i.collide=!1;var j,k=Lb;if(i.shape==tb)v(gb,i)&&(i.collide=!0,k.x=gb.x-i.x,Lb.y=gb.y-i.y,j=t(k.x,k.y),k.l=i.r+gb.r-j,k.x=k.x/j,k.y=k.y/j);else if(i.shape==ub){var l=i.kind==zb&&i.movingUp;if(!l&&w(gb,i,k)){i.collide=!0,x(Kb,i.x,i.y,i.x2,i.y2);var m=y(Kb,gb.x,gb.y)!==y(Kb,gb.prevX,gb.prevY);0>=m?j=gb.r-k.l:(j=gb.r+k.l,k.x*=-1,k.y*=-1),k.x/=k.l,k.y/=k.l,k.l=j}if(l){var n=w(gb,i,k),o=1==i.table||3==i.table;console.log("rising paddle",i,o?"REVERSE":"");var p,q;if(n?console.log(" paddle direct collision"):(x(Kb,i.x,i.y,i.prevX2,i.prevY2),p=y(Kb,gb.prevX,gb.prevY,o),console.log(" before",0,0,"and",i.prevX2-i.x,i.prevY2-i.y,p,"m",Kb.m,"p",Kb.p),console.log(" ball before:",gb.prevX-i.x,gb.prevY-i.y),x(Kb,i.x,i.y,i.x2,i.y2),q=y(Kb,gb.x,gb.y,o),console.log(" after",0,0,"and",i.x2-i.x,i.y2-i.y,q,"m",Kb.m,"p",Kb.p),console.log(" ball now:",gb.x-i.x,gb.y-i.y)),n||p!==q){n||console.log("  checking dotprod");var r=gb.x-i.x,s=gb.y-i.y,z=r*i._ux+s*i._uy;if((n||z>0)&&(n||r*r+s*s<i.l*i.l)){i.collide=!0;var A=(t(r,s),z/i.l);k.x=i.x+A*i._ux/i.l,k.y=i.y+A*i._uy/i.l,k.x=gb.x-k.x,k.y=gb.y-k.y,k.l=t(k.x,k.y),k.x/=k.l,k.y/=k.l;var B=i._uy/i.l,C=-i._ux/i.l;console.log("   NORMALE PAD",B,C,i),(i.mirror&&(0===i.table||3==i.table)||!i.mirror&&(1==i.table||2==i.table))&&(B*=-1,C*=-1);var D=B*k.x+C*k.y;0>D&&(k.x*=-1,k.y*=-1),k.l=k.l+gb.r,gb.x+=k.x*k.l,gb.y+=k.y*k.l,gb.collide=!0;var E=A/i.l;E=.2+(.3*E+.7*E*E);var F=20*E>>0,G=Bb*E,H=k.x*G,I=k.y*G;gb.boostCpt?(gb.boostCpt+=F>2?2:F,gb.boostX=.2*H+.8*gb.boostX,gb.boostY=.2*I+.8*gb.boostY):(console.log("   INITIAL BOOST!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"),gb.boostCpt=F,gb.boostX=H,gb.boostY=I),gb.boostX*=.6+.8*M(),gb.boostY*=.6+.8*M(),console.log("   boosting",E,gb.boostCpt,gb.boostX,gb.boostY);continue}}}}if(i.collide){gb.x+=k.x*k.l,gb.y+=k.y*k.l,gb.collide=!0;var J=t(gb.v.x,gb.v.y),L=gb.v.x/J,N=gb.v.y/J,O=-k.y,P=k.x,Q=O*L+P*N;0>Q&&(O=-O,P=-P);var R=L*k.x+N*k.y;0>R&&(R=-R);var T=K.sin(K.acos(R));0>T&&(T=-T);var U=i.bounciness||.2;k.x*=R*U*J,k.y*=R*U*J,O*=T*J,P*=T*J,gb.v.x=k.x+O,gb.v.y=k.y+P}}}gb.a.x=gb.a.y=0,gb.prevX=gb.x,gb.prevY=gb.y,gb.x+Cb<0?Hb=!1:gb.x-Cb>V?Hb=!1:gb.y+Cb<0?Hb=!1:gb.y-Cb>V&&(Hb=!1)}var W;for(a=0,b=fb.n;b>a;a++)W=fb[a],W.cpt--,W.cpt>0&&(W.x+=W.v.x,W.y+=W.v.y);for(a=0;a<fb.n;a++)W=fb[a],0===W.cpt&&(fb[a]=fb[fb.n-1],fb[fb.n-1]=W,fb.n--,a--)}function e(){var a=gb.x,b=gb.y,c=a-V/2,d=b-V/2,e=c,f=d;0>e&&(e*=-1),0>f&&(f*=-1);var g=O/2+Q;if(g>e&&g>f){var h=e-g,i=f-g,j=h*h+i*i;if(g*g>j){var k=L(j);h=h*g/k,i=i*g/k,a=h+g,b=i+g,0>c&&(a=-a),0>d&&(b=-b),a=V/2+a,b=V/2+b}}else f>e?a=V/2:b=V/2;a=s(a,gb.x-.3*S,gb.x+.3*S),b=s(b,gb.y-.3*T,gb.y+.3*T),a=s(a-S/2,0,V-S),b=s(b-T/2,0,V-T),Hb?(cb+=.3*(a-cb),db+=.3*(b-db)):(cb=a,db=b)}function f(){bb.clearRect(0,0,S,T),D(Y,gb.x,gb.y,1,gb.collide?"red":gb.boostCpt>0?"orange":"white"),D(Y,cb+S/2,db+T/2,1,lb),C(bb,X,-cb,-db);for(var a=0,b=eb.length;b>a;a++){var c,d,e,f=eb[a],g=f.x-cb,h=f.y-db;if(f.shape==tb){if(f==gb){if(d=qb,c=rb,Ib>0&&!Hb){var i=4*s(Ib/Jb,0,1)>>0;g+=i*M()>>0,h+=i*M()>>0,4==i&&(d="#f00")}}else f.kind==wb?(c=0,d=0):(e=2,d=mb,c="#000",f.collide&&(d=ob));(c||d)&&D(bb,g,h,f.r,c,d,e)}else f.shape==ub&&(f.kind==wb?d=0:(d=mb,f.kind==zb&&(d=pb,f.collide&&(d=ob))),d&&E(bb,f.x-cb,f.y-db,f.x2-cb,f.y2-db,d,2))}var j;for(a=0,b=fb.n;b>a;a++)j=fb[a],E(bb,j.x-cb,j.y-db,j.x-j.v.x-cb,j.y-j.v.y-db,sb,10);E(bb,gb.x-cb,gb.y-db,gb.x-cb+10*gb.v.x,gb.y-db+10*gb.v.y,"#0f0",3)}function g(){c(),f(),d(),e(),f(),window.requestAnimationFrame(g)}function h(){gb=j(k(V/2,V-50,Cb,vb)),n(k(60,250,30,xb)),n(l(0,200,150,100,yb)),n(l(150,100,270,50,zb)),hb=eb.slice(-8);for(var a=hb[0],b=t(a.x-a.x2,a.y-a.y2),c=2*-K.acos((a.x2-a.x)/b),d=0;d<hb.length;d++)a=hb[d],a.l=b,a.ux=a.x2-a.x,a.uy=a.y2-a.y,a.amax=c,(1==a.table||2==a.table)&&(a.amax*=-1)}function i(a,b,c,d){return{x:c||0,y:d||0,shape:a,kind:b,v:{x:0,y:0},a:{x:0,y:0}}}function j(a){return eb.push(a),a}function k(a,b,c,d){var e=i(tb,d,a,b);return e.r=c,e}function l(a,b,c,d,e){var f=i(ub,e,a,b);return f.x2=c,f.y2=d,f}function m(a){for(var b=0;4>b;b++){var c=p(a);o(c,"x","y",b),c.shape==ub&&o(c,"x2","y2",b),j(c),c.table=b}}function n(a){m(a),a.x=O-a.x,a.shape==ub&&(a.x2=O-a.x2),a.mirror=!0,m(a)}function o(a,b,c,d){var e=a[b],f=a[c];if(0===d||2==d)e+=P+Q,0===d&&(f=V-f);else{var g=f;f=P+Q+e,e=g,1==d&&(e=V-e)}a[b]=e>>0,a[c]=f>>0}function p(a){return JSON.parse(JSON.stringify(a))}function q(a){return a}function r(a){return V-a}function s(a,b,c){return b>a?b:a>c?c:a}function t(a,b){return L(a*a+b*b)}function u(a,b){b=(b||1)/t(a.x,a.y),a.x*=b,a.y*=b}function v(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.r+b.r;return e*e>c*c+d*d}function w(a,b,c){var d=a.x,e=a.y,f=a.r,g=b.x,h=b.y,i=b.x2,j=b.y2,k=i-g,l=j-h,m=K.sqrt(k*k+l*l),n=(i-g)/m,o=(j-h)/m,p=n*(d-g)+o*(e-h),q=p*n+g,r=p*o+h;if((i>g&&q>=g&&i>=q||g>i&&q>=i&&g>=q||g==i&&q==g)&&(j>h&&r>=h&&j>=r||h>j&&r>=j&&h>=r||h==j&&r==h)){var s=r-e,t=q-d,u=L(t*t+s*s);if(f>=u)return c.ex=q,c.ey=r,c.x=-t,c.y=-s,c.l=u,!0}return!1}function x(a,b,c,d,e){b==d?(a.vert=!0,a.x=b):(a.vert=!1,a.m=(c-e)/(b-d),a.p=c-a.m*b)}function y(a,b,c,d){return a.vert?b<a.x:d?b>(c-a.p)/a.m:c>a.m*b+a.p}function z(a,b){var c=I.createElement("canvas");return c.width=a,c.height=b,c}function A(a){return a.getContext("2d")}function B(a,b,c,d,e,f){f&&(a.fillStyle=f.width?a.createPattern(f,"repeat"):f),a.fillRect(b,c,d,e)}function C(){var a=[].slice.call(arguments),b=a.shift();b.drawImage.apply(b,a)}function D(a,b,c,d,e,f,g){a.beginPath(),a.arc(b,c,d,0,2*K.PI,!1),e&&(a.fillStyle=e,a.fill()),f&&(a.lineWidth=g||2,a.strokeStyle=f,a.stroke())}function E(a,b,c,d,e,f,g){g&&(a.lineWidth=g),f&&(a.strokeStyle=f),a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke()}function F(a,b){b||(b=window.e);var c=b.keyCode;b.charCode&&!c&&(c=b.charCode),Fb[Mb[c]]=a}function G(a,b){var c;"which"in b?c=3==b.which:"button"in b&&(c=2==b.button),c?Gb.right=a:Gb.left=a,Gb.x=b.clientX+cb,Gb.y=b.clientY+db}var H=window,I=H.document,J=I.body,K=H.Math,L=K.sqrt,M=(L(2),K.random),N=String.fromCharCode,O=600,P=200,Q=300,R=Q+O/2;R=t(R,R)-Q>>0;var S,T,U,V=O+2*P+2*Q,W=20,X=z(V,V),Y=A(X),Z=z(V,V),$=(A(Z),z(W,W)),_=A($),ab=z(S,T),bb=A(ab),cb=0,db=0;window.onresize=function(){S=s(H.innerWidth,O,V),T=s(H.innerHeight,O,V),U=K.min(S,T),ab.width=S-=S%2,ab.height=T-=T%2},J.onresize(),J.appendChild(ab);var eb,fb,gb,hb,ib="#111",jb="#222",kb="#333",lb="#444",mb="#08e",nb="#000",ob="#0d0",pb="#dd0",qb="#000",rb="#fff",sb="#fa0",tb="c",ub="l",vb="b",wb="bg",xb="bp",yb="o",zb="p",Ab="s",Bb=15,Cb=14,Db=.2,Eb=.99,Fb={},Gb={},Hb=!1,Ib=0,Jb=100,Kb={},Lb={};b(),g();var Mb={37:"left",38:"up",39:"right",40:"down",32:"space",27:"esc",82:"R",13:"Enter"};I.onkeyup=function(a){F(!1,a),27==a.keyCode&&(window._stopped?(window._stopped=!1,window.requestAnimationFrame=window._raf):(window._stopped=!0,window._raf=window.requestAnimationFrame,window.requestAnimationFrame=function(){})),13==a.keyCode&&window._stopped&&g()},I.onkeydown=function(a){F(!0,a)},I.onmousedown=function(a){G(!0,a)},I.onmouseup=function(a){G(!1,a)},I.onmousemove=function(a){Gb.x=a.clientX+cb,Gb.y=a.clientY+db},I.oncontextmenu=function(){return!1}},function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();