/*! pinball-em-up 02-09-2014 */
window.onload=function(){"use strict";function a(){function a(a,b){var c=4;X.beginPath(),X.strokeStyle=jb,X.fillStyle=kb,X.lineWidth=2,X.moveTo(a(-c),b(-c)),X.lineTo(a(O+P),b(-c)),X.lineTo(a(O+P),b(O)),X.arcTo(a(O+P),b(O+P),a(O),b(O+P),P),X.lineTo(a(-c),b(O+P)),X.closePath(),X.fill(),X.stroke(),j(k(a(O),b(O),P,rb)),j(l(a(0),b(O+P),a(O),b(O+P),rb)),j(l(a(O+P),b(0),a(O+P),b(O),rb))}B(Z,0,0,V,V,gb),B(Z,0,0,V-1,V-1,hb),B(Z,0,0,V-2,V-2,fb),B(X,0,0,U,U,Y),E(X,0,0,U,U,ib),E(X,U,0,0,U,ib),D(X,U/2,U/2,8,fb,ib),a(q,q),a(q,r),a(r,q),a(r,r)}function b(){Cb=0,Bb=!1,cb=[],a(),h()}function c(){if(!Bb){if(zb.space)Cb++;else if(Cb>0){var a=Cb/Db;a>1&&(a=1),db.boostX=3*(1+M()),db.boostY=-vb,db.boostCpt=10+50*a,Bb=!0}zb.R&&(Bb=!0)}Ab.down&&(Cb=0,Bb=!0,db.x=Ab.x,db.y=Ab.y,db.a.x=db.a.y=0,db.v.x=db.v.y=0,db.boostCpt=0,Ab.down=!1,console.log("mouse teleport",db));for(var b=0;b<eb.length;b++){var c=eb[b],d=!c.mirror,e=d&&(zb.up||zb.left)||!d&&(zb.down||zb.right),f=c.ux,g=c.uy;c.cpt=c.cpt||0;var h=7;if(c.max=!1,e?c.cpt<h?c.cpt++:c.max=!0:c.cpt>0&&c.cpt--,c.prevX2=c.x2,c.prevY2=c.y2,c.movingUp=e&&!c.max,c.moving=0!==c.cpt,c.cpt>0){var i=c.amax*(c.cpt/h);c.mirror&&(i*=-1);var j=K.cos(i),k=K.sin(i);f=c.ux*j-c.uy*k,g=c.ux*k+c.uy*j}c._ux=f,c._uy=g,c.x2=c.x+f,c.y2=c.y+g}}function d(){if(Bb){db.boostCpt>0&&(db.boostCpt--,db.a.x=db.boostX,db.a.y=db.boostY);var a=0,b=0;if(!db.noGrav){var c=db.x-U/2,d=db.y-U/2;d>c?d>-c?b=xb:a=-xb:d>-c?a=xb:b=-xb}db.noGrav=!1,db.a.x+=a,db.a.y+=b,db.v.x=db.v.x+db.a.x,db.v.y=db.v.y+db.a.y,a?(db.v.x*=yb,db.v.y*=yb):(db.v.x*=yb,db.v.y*=yb),db.v.x*db.v.x+db.v.y*db.v.y>vb*vb&&u(db.v,vb),db.x+=db.v.x,db.y+=db.v.y,console.log("===================================================================================="),console.log("loop","collided",db.collide,"boost",db.boostCpt),db.collide=!1;for(var e=(db.v.x,db.v.y,0),f=cb.length;f>e;e++){var g=cb[e];if(g!=db){g.collide=!1;var h,i=Fb;if(g.shape==ob)v(db,g)&&(g.collide=!0,i.x=db.x-g.x,Fb.y=db.y-g.y,h=t(i.x,i.y),i.l=g.r+db.r-h,i.x=i.x/h,i.y=i.y/h);else if(g.shape==pb){var j=g.kind==ub&&g.movingUp;if(!j&&w(db,g,i)){g.collide=!0,x(Eb,g.x,g.y,g.x2,g.y2);var k=y(Eb,db.x,db.y)!==y(Eb,db.prevX,db.prevY);0>=k?h=db.r-i.l:(h=db.r+i.l,i.x*=-1,i.y*=-1),i.x/=i.l,i.y/=i.l,i.l=h}if(j){var l=w(db,g,i),m=1==g.table||3==g.table;console.log("rising paddle",g,m?"REVERSE":"");var n,o;if(l?console.log(" paddle direct collision"):(x(Eb,g.x,g.y,g.prevX2,g.prevY2),n=y(Eb,db.prevX,db.prevY,m),console.log(" before",0,0,"and",g.prevX2-g.x,g.prevY2-g.y,n,"m",Eb.m,"p",Eb.p),console.log(" ball before:",db.prevX-g.x,db.prevY-g.y),x(Eb,g.x,g.y,g.x2,g.y2),o=y(Eb,db.x,db.y,m),console.log(" after",0,0,"and",g.x2-g.x,g.y2-g.y,o,"m",Eb.m,"p",Eb.p),console.log(" ball now:",db.x-g.x,db.y-g.y)),l||n!==o){l||console.log("  checking dotprod");var p=db.x-g.x,q=db.y-g.y,r=p*g._ux+q*g._uy;if((l||r>0)&&(l||p*p+q*q<g.l*g.l)){g.collide=!0;var s=(t(p,q),r/g.l);i.x=g.x+s*g._ux/g.l,i.y=g.y+s*g._uy/g.l,i.x=db.x-i.x,i.y=db.y-i.y,i.l=t(i.x,i.y),i.x/=i.l,i.y/=i.l;var z=g._uy/g.l,A=-g._ux/g.l;console.log("   NORMALE PAD",z,A,g),(g.mirror&&(0===g.table||3==g.table)||!g.mirror&&(1==g.table||2==g.table))&&(z*=-1,A*=-1);var B=z*i.x+A*i.y;0>B&&(i.x*=-1,i.y*=-1),i.l=i.l+db.r,db.x+=i.x*i.l,db.y+=i.y*i.l,db.collide=!0;var C=s/g.l;C=.2+(.3*C+.7*C*C);var D=20*C>>0,E=vb*C,F=i.x*E,G=i.y*E;db.boostCpt?(db.boostCpt+=D>2?2:D,db.boostX=.2*F+.8*db.boostX,db.boostY=.2*G+.8*db.boostY):(console.log("   INITIAL BOOST!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"),db.boostCpt=D,db.boostX=F,db.boostY=G),db.boostX*=.8+.4*M(),db.boostY*=.8+.4*M(),console.log("   boosting",C,db.boostCpt,db.boostX,db.boostY);continue}}}}if(g.collide){db.x+=i.x*i.l,db.y+=i.y*i.l,db.collide=!0;var H=t(db.v.x,db.v.y),I=db.v.x/H,J=db.v.y/H,L=-i.y,N=i.x,O=L*I+N*J;0>O&&(L=-L,N=-N);var P=I*i.x+J*i.y;0>P&&(P=-P);var Q=K.sin(K.acos(P));0>Q&&(Q=-Q);var R=g.bounciness||.2;i.x*=P*R*H,i.y*=P*R*H,L*=Q*H,N*=Q*H,db.v.x=i.x+L,db.v.y=i.y+N}}}db.a.x=db.a.y=0,db.prevX=db.x,db.prevY=db.y,db.x+wb<0?Bb=!1:db.x-wb>U?Bb=!1:db.y+wb<0?Bb=!1:db.y-wb>U&&(Bb=!1)}}function e(){var a=db.x,b=db.y,c=a-U/2,d=b-U/2,e=c,f=d;0>e&&(e*=-1),0>f&&(f*=-1);var g=N/2+P;if(g>e&&g>f){var h=e-g,i=f-g,j=h*h+i*i;if(g*g>j){var k=L(j);h=h*g/k,i=i*g/k,a=h+g,b=i+g,0>c&&(a=-a),0>d&&(b=-b),a=U/2+a,b=U/2+b}}else f>e?a=U/2:b=U/2;a=s(a,db.x-.3*R,db.x+.3*R),b=s(b,db.y-.3*S,db.y+.3*S),a=s(a-R/2,0,U-R),b=s(b-S/2,0,U-S),Bb?(ab+=.1*(a-ab),bb+=.1*(b-bb)):(ab=a,bb=b)}function f(){D(X,db.x,db.y,1,db.collide?"red":db.boostCpt>0?"orange":"white"),D(X,ab+R/2,bb+S/2,1,ib),C(_,W,-ab,-bb);for(var a=0,b=cb.length;b>a;a++){var c,d,e,f=cb[a],g=f.x-ab,h=f.y-bb;if(f.shape==ob){if(f==db){if(d=lb,c=mb,Cb>0&&!Bb){var i=4*s(Cb/Db,0,1)>>0;g+=i*M()>>0,h+=i*M()>>0,4==i&&(d="#f00")}}else f.kind==rb?(e=1,c=0,d=nb):(e=2,d=jb,c="#f0f",f.collide&&(c="#f8f"));D(_,g,h,f.r,c,d,e)}else f.shape==pb&&(d=f.collide?jb:nb,E(_,f.x-ab,f.y-bb,f.x2-ab,f.y2-bb,d,2),D(_,f.x-ab,f.y-bb,4,"red"),f.kind==ub&&E(_,f.x-ab,f.y-bb,f.prevX2-ab,f.prevY2-bb,"yellow",2))}E(_,db.x-ab,db.y-bb,db.x-ab+10*db.v.x,db.y-bb+10*db.v.y,"#0f0")}function g(){c(),d(),e(),f(),window.requestAnimationFrame(g)}function h(){db=j(k(U/2,U-50,wb,qb)),n(k(60,250,30,sb)),n(l(0,200,150,100,tb)),n(l(150,100,270,50,ub)),eb=cb.slice(-8);for(var a=eb[0],b=t(a.x-a.x2,a.y-a.y2),c=2*-K.acos((a.x2-a.x)/b),d=0;d<eb.length;d++)a=eb[d],a.l=b,a.ux=a.x2-a.x,a.uy=a.y2-a.y,a.amax=c,(1==a.table||2==a.table)&&(a.amax*=-1)}function i(a,b,c,d){return{x:c||0,y:d||0,shape:a,kind:b,v:{x:0,y:0},a:{x:0,y:0}}}function j(a){return cb.push(a),a}function k(a,b,c,d){var e=i(ob,d,a,b);return e.r=c,e}function l(a,b,c,d,e){var f=i(pb,e,a,b);return f.x2=c,f.y2=d,f}function m(a){for(var b=0;4>b;b++){var c=p(a);o(c,"x","y",b),c.shape==pb&&o(c,"x2","y2",b),j(c),c.table=b}}function n(a){m(a),a.x=N-a.x,a.shape==pb&&(a.x2=N-a.x2),a.mirror=!0,m(a)}function o(a,b,c,d){var e=a[b],f=a[c];if(0===d||2==d)e+=O+P,0===d&&(f=U-f);else{var g=f;f=O+P+e,e=g,1==d&&(e=U-e)}a[b]=e>>0,a[c]=f>>0}function p(a){return JSON.parse(JSON.stringify(a))}function q(a){return a}function r(a){return U-a}function s(a,b,c){return b>a?b:a>c?c:a}function t(a,b){return L(a*a+b*b)}function u(a,b){b=(b||1)/t(a.x,a.y),a.x*=b,a.y*=b}function v(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.r+b.r;return e*e>c*c+d*d}function w(a,b,c){var d=a.x,e=a.y,f=a.r,g=b.x,h=b.y,i=b.x2,j=b.y2,k=i-g,l=j-h,m=K.sqrt(k*k+l*l),n=(i-g)/m,o=(j-h)/m,p=n*(d-g)+o*(e-h),q=p*n+g,r=p*o+h;if((i>g&&q>=g&&i>=q||g>i&&q>=i&&g>=q||g==i&&q==g)&&(j>h&&r>=h&&j>=r||h>j&&r>=j&&h>=r||h==j&&r==h)){var s=r-e,t=q-d,u=L(t*t+s*s);if(f>=u)return c.ex=q,c.ey=r,c.x=-t,c.y=-s,c.l=u,!0}return!1}function x(a,b,c,d,e){b==d?(a.vert=!0,a.x=b):(a.vert=!1,a.m=(c-e)/(b-d),a.p=c-a.m*b)}function y(a,b,c,d){return a.vert?b<a.x:d?b>(c-a.p)/a.m:c>a.m*b+a.p}function z(a,b){var c=I.createElement("canvas");return c.width=a,c.height=b,c}function A(a){return a.getContext("2d")}function B(a,b,c,d,e,f){f&&(a.fillStyle=f.width?a.createPattern(f,"repeat"):f),a.fillRect(b,c,d,e)}function C(){var a=[].slice.call(arguments),b=a.shift();b.drawImage.apply(b,a)}function D(a,b,c,d,e,f,g){a.beginPath(),a.arc(b,c,d,0,2*K.PI,!1),e&&(a.fillStyle=e,a.fill()),f&&(a.lineWidth=g||2,a.strokeStyle=f,a.stroke())}function E(a,b,c,d,e,f,g){g&&(a.lineWidth=g),f&&(a.strokeStyle=f),a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke()}function F(a,b){b||(b=window.e);var c=b.keyCode;b.charCode&&!c&&(c=b.charCode),zb[Gb[c]]=a}function G(a,b){Ab.down=a,Ab.x=b.clientX+ab,Ab.y=b.clientY+bb}var H=window,I=H.document,J=I.body,K=H.Math,L=K.sqrt,M=(L(2),K.random),N=600,O=800,P=200,Q=P+N/2;Q=t(Q,Q)-P>>0;var R,S,T,U=N+2*O+2*P,V=20,W=z(U,U),X=A(W),Y=z(V,V),Z=A(Y),$=z(R,S),_=A($),ab=0,bb=0;window.onresize=function(){R=K.max(H.innerWidth,N),S=K.max(H.innerHeight,N),T=K.min(R,S),$.width=R-=R%2,$.height=S-=S%2},J.onresize(),J.appendChild($);var cb,db,eb,fb="#111",gb="#222",hb="#333",ib="#444",jb="#ddd",kb="#000",lb="#000",mb="#fff",nb="#0f0",ob="c",pb="l",qb="b",rb="bg",sb="bp",tb="o",ub="p",vb=40,wb=14,xb=.5,yb=.94,zb={},Ab={},Bb=!1,Cb=0,Db=100,Eb={},Fb={};b(),g();var Gb={37:"left",38:"up",39:"right",40:"down",32:"space",27:"esc",82:"R",13:"Enter"};I.onkeyup=function(a){F(!1,a),27==a.keyCode&&(window._stopped?(window._stopped=!1,window.requestAnimationFrame=window._raf):(window._stopped=!0,window._raf=window.requestAnimationFrame,window.requestAnimationFrame=function(){})),13==a.keyCode&&window._stopped&&g()},I.onkeydown=function(a){F(!0,a)},I.onmousedown=function(a){G(!1,a)},I.onmouseup=function(a){G(!0,a)}},function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();