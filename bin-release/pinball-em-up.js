/*! pinball-em-up 04-09-2014 */
window.onload=function(){"use strict";function a(){function a(a,b){var c=4;db.strokeStyle=tb,db.fillStyle=ub,db.lineWidth=2,db.beginPath(),db.moveTo(a(-c),b(-c)),db.lineTo(a(R+S),b(-c)),db.lineTo(a(R+S),b(R)),db.arcTo(a(R+S),b(R+S),a(R),b(R+S),S),db.lineTo(a(-c),b(R+S)),db.closePath(),db.fill(),db.stroke(),j(k(a(R),b(R),S,Db)),j(l(a(0),b(R+S),a(R),b(R+S),Db)),j(l(a(R+S),b(0),a(R+S),b(R),Db)),db.fillStyle=wb;var h=a==q?f:g;db.fillText(P(h),a(R+S+130)-2,b(50)-3),h=b==q?d:e,db.fillText(P(h),a(50)-2,b(R+S+130)-3)}var b=z(bb,bb),c=A(b);B(c,0,0,bb,bb,qb),B(c,0,0,bb-1,bb-1,rb),B(c,0,0,bb-2,bb-2,pb),B(db,0,0,_,_,b),E(db,0,0,_,_,sb),E(db,_,0,0,_,sb),D(db,ab,ab,8,pb,sb);var d=8679,e=8681,f=8678,g=8680;db.font="64px sans-serif",db.textAlign="center",db.textBaseline="middle",a(q,q),a(q,r),a(r,q),a(r,r)}function b(){Pb=0,Ob=!1,kb=[],lb=[],lb.n=0,a(),h()}function c(){if(!Ob){if(Mb.space)Pb++;else if(Pb>0){var a=Pb/Qb;a>1&&(a=1),mb.boostX=3*(1+O()),mb.boostY=-Ib,mb.boostCpt=10+50*a,Ob=!0}Mb.R&&(Ob=!0)}for(var b=0;b<nb.length;b++){var c,d=nb[b],e=!d.mirror;c=1==d.table?e?Mb.up||Mb.right:Mb.down||Mb.left:e?Mb.up||Mb.left:Mb.down||Mb.right;var f=d.ux,g=d.uy;d.cpt=d.cpt||0;var h=7;if(d.max=!1,c?d.cpt<h?d.cpt++:d.max=!0:d.cpt>0&&d.cpt--,d.prevX2=d.x2,d.prevY2=d.y2,d.movingUp=c&&!d.max,d.moving=0!==d.cpt,d.cpt>0){var j=d.amax*(d.cpt/h);d.mirror&&(j*=-1);var k=L.cos(j),l=L.sin(j);f=d.ux*k-d.uy*l,g=d.ux*l+d.uy*k}d._ux=f,d._uy=g,d.x2=d.x+f,d.y2=d.y+g}if(Nb.middle&&(Pb=0,Ob=!0,mb.x=Nb.x,mb.y=Nb.y,mb.a.x=mb.a.y=0,mb.v.x=mb.v.y=0,mb.boostCpt=0,Nb.right=!1,console.log("mouse teleport",mb)),Nb.right&&(Sb.x=Nb.x-mb.x,Sb.y=Nb.y-mb.y,u(Sb),mb.boostCpt=6,mb.boostX=2.5*Sb.x,mb.boostY=2.5*Sb.y,Nb.right=!1),Nb.left&&(Sb.x=Nb.x-mb.x,Sb.y=Nb.y-mb.y,u(Sb),Nb.leftCpt%10===0)){var m;lb.length==lb.n?(m=i(Bb,Hb),lb.push(m)):m=lb[lb.n],lb.n++;var n=10;m.x=mb.x+Sb.x*(n+Jb),m.y=mb.y+Sb.y*(n+Jb),m.v.x=Sb.x*n,m.v.y=Sb.y*n,m.cpt=100}Nb.left?Nb.leftCpt++:Nb.leftCpt=0}function d(){var a,b,c;for(a=0,b=ob.length;b>a;a++)c=ob[a],c.a=c.a+2*c.da*M,c.x=ab+L.cos(c.a)*c.d,c.y=ab+L.sin(c.a)*c.d;if(Ob){mb.boostCpt>0&&(mb.boostCpt--,mb.a.x=mb.boostX,mb.a.y=mb.boostY);var d=0,e=0,f=Kb;s=ab-mb.x,z=ab-mb.y;var g=U/2,h=t(s,z);g>h&&(s/=h,z/=h,f*=.1+.9*h/g);var i=mb.x-ab,j=mb.y-ab;j>i?j>-i?e=f:d=-f:j>-i?d=f:e=-f,mb.a.x+=d,mb.a.y+=e,mb.v.x=mb.v.x+mb.a.x,mb.v.y=mb.v.y+mb.a.y,mb.v.x*=Lb,mb.v.y*=Lb,mb.v.x*mb.v.x+mb.v.y*mb.v.y>Ib*Ib&&u(mb.v,Ib),mb.x+=mb.v.x,mb.y+=mb.v.y,mb.collide=!1;{mb.v.x,mb.v.y}for(a=0,b=kb.length;b>a;a++)if(c=kb[a],c!=mb){c.collide=!1;var k,l=Sb;if(c.shape==Ab)v(mb,c)&&(c.collide=!0,l.x=mb.x-c.x,Sb.y=mb.y-c.y,k=t(l.x,l.y),l.l=c.r+mb.r-k,l.x=l.x/k,l.y=l.y/k);else if(c.shape==Bb){var m=c.kind==Gb&&c.movingUp;if(!m&&w(mb,c,l)){c.collide=!0,x(Rb,c.x,c.y,c.x2,c.y2);var n=y(Rb,mb.x,mb.y)!==y(Rb,mb.prevX,mb.prevY);0>=n?k=mb.r-l.l:(k=mb.r+l.l,l.x*=-1,l.y*=-1),l.x/=l.l,l.y/=l.l,l.l=k}if(m){var o=w(mb,c,l),p=1==c.table||3==c.table;console.log("rising paddle",c,p?"REVERSE":"");var q,r;if(o?console.log(" paddle direct collision"):(x(Rb,c.x,c.y,c.prevX2,c.prevY2),q=y(Rb,mb.prevX,mb.prevY,p),console.log(" before",0,0,"and",c.prevX2-c.x,c.prevY2-c.y,q,"m",Rb.m,"p",Rb.p),console.log(" ball before:",mb.prevX-c.x,mb.prevY-c.y),x(Rb,c.x,c.y,c.x2,c.y2),r=y(Rb,mb.x,mb.y,p),console.log(" after",0,0,"and",c.x2-c.x,c.y2-c.y,r,"m",Rb.m,"p",Rb.p),console.log(" ball now:",mb.x-c.x,mb.y-c.y)),o||q!==r){o||console.log("  checking dotprod");var s=mb.x-c.x,z=mb.y-c.y,A=s*c._ux+z*c._uy;if((o||A>0)&&(o||s*s+z*z<c.l*c.l)){c.collide=!0;var B=(t(s,z),A/c.l);l.x=c.x+B*c._ux/c.l,l.y=c.y+B*c._uy/c.l,l.x=mb.x-l.x,l.y=mb.y-l.y,l.l=t(l.x,l.y),l.x/=l.l,l.y/=l.l;var C=c._uy/c.l,D=-c._ux/c.l;console.log("   NORMALE PAD",C,D,c),(c.mirror&&(0===c.table||3==c.table)||!c.mirror&&(1==c.table||2==c.table))&&(C*=-1,D*=-1);var E=C*l.x+D*l.y;0>E&&(l.x*=-1,l.y*=-1),l.l=l.l+mb.r,mb.x+=l.x*l.l,mb.y+=l.y*l.l,mb.collide=!0;var F=B/c.l;F=.2+(.3*F+.7*F*F);var G=20*F>>0,H=Ib*F,I=l.x*H,J=l.y*H;mb.boostCpt?(mb.boostCpt+=G>2?2:G,mb.boostX=.2*I+.8*mb.boostX,mb.boostY=.2*J+.8*mb.boostY):(mb.boostCpt=G,mb.boostX=I,mb.boostY=J),mb.boostX*=.6+.8*O(),mb.boostY*=.6+.8*O(),console.log("   boosting",F,mb.boostCpt,mb.boostX,mb.boostY);continue}}}}if(c.collide){c.colCpt=20,mb.x+=l.x*l.l,mb.y+=l.y*l.l,mb.collide=!0;var K=t(mb.v.x,mb.v.y),N=mb.v.x/K,P=mb.v.y/K,Q=-l.y,R=l.x,S=Q*N+R*P;0>S&&(Q=-Q,R=-R);var T=N*l.x+P*l.y;0>T&&(T=-T);var V=L.sin(L.acos(T));0>V&&(V=-V);var W=c.kind==Eb?1.5:.2;l.x*=T*W*K,l.y*=T*W*K,Q*=V*K,R*=V*K,mb.v.x=l.x+Q,mb.v.y=l.y+R}}mb.a.x=mb.a.y=0,mb.prevX=mb.x,mb.prevY=mb.y,mb.x+Jb<0?Ob=!1:mb.x-Jb>_?Ob=!1:mb.y+Jb<0?Ob=!1:mb.y-Jb>_&&(Ob=!1)}var X;for(a=0,b=lb.n;b>a;a++)X=lb[a],X.cpt--,X.cpt>0&&(X.x+=X.v.x,X.y+=X.v.y);for(a=0;a<lb.n;a++)X=lb[a],0===X.cpt&&(lb[a]=lb[lb.n-1],lb[lb.n-1]=X,lb.n--,a--)}function e(){Z=X,$=Y;var a=mb.x,b=mb.y,c=a-ab,d=b-ab,e=c,f=d;0>e&&(e*=-1),0>f&&(f*=-1);var g=Q/2+S;if(g>e&&g>f){var h=e-g,i=f-g,j=h*h+i*i;if(g*g>j){var k=N(j);h=h*g/k,i=i*g/k,a=h+g,b=i+g,0>c&&(a=-a),0>d&&(b=-b),a=ab+a,b=ab+b}}else f>e?a=ab:b=ab;a=s(a,mb.x-.3*U,mb.x+.3*U),b=s(b,mb.y-.3*V,mb.y+.3*V),a=s(a-U/2,0,_-U),b=s(b-V/2,0,_-V),Ob?(X+=.3*(a-X),Y+=.3*(b-Y)):(X=a,Y=b)}function f(){F(fb),F(jb),C(fb,gb,0,0),hb.clearRect(0,0,U,V),hb.save(),hb.globalAlpha=.9,C(hb,eb,-X+Z,-Y+$),hb.restore(),F(fb),mb.boostCpt>0?(D(hb,mb.x-X,mb.y-Y,6,"orange"),D(hb,mb.prevX-X,mb.prevY-Y,6,"orange")):D(hb,mb.x-X,mb.y-Y,2,"white");for(var a=0,b=kb.length;b>a;a++){var c,d,e,f=kb[a],g=f.x-X,h=f.y-Y;if(f==mb){if(Pb>0&&!Ob){var i=4*s(Pb/Qb,0,1)>>0;g+=i*O()>>0,h+=i*O()>>0,4==i&&(d="#f00")}var j=L.atan2(mb.v.y,mb.v.x);mb.cpt=++mb.cpt%20;var k=mb.cpt;k>10&&(k=20-k),0===k?D(jb,mb.x-X,mb.y-Y,Jb,yb,xb):(jb.strokeStyle=xb,jb.fillStyle=yb,jb.lineWidth=2,k*=.3*M/10,jb.beginPath(),jb.arc(mb.x-X,mb.y-Y,mb.r,j+k,j-k),jb.lineTo(mb.x-X,mb.y-Y),jb.closePath(),jb.fill(),jb.stroke())}else f.shape==Ab?(f.kind==Db?(c=0,d=0):(e=2,d=tb,c="#000",f.colCpt>0&&(f.colCpt--,d=vb)),(c||d)&&D(jb,g,h,f.r,c,d,e)):f.shape==Bb&&(f.kind==Db?d=0:(d=tb,f.kind==Gb&&(d=wb,f.collide&&(d=vb))),d&&E(jb,f.x-X,f.y-Y,f.x2-X,f.y2-Y,d,2))}var l;for(a=0,b=lb.n;b>a;a++)l=lb[a],D(jb,l.x-X,l.y-Y,4,zb),E(hb,l.x-X,l.y-Y,l.x-l.v.x-X,l.y-l.v.y-Y,zb,2);C(fb,cb,-X,-Y),C(fb,gb,0,0),C(fb,ib,0,0)}function g(){c(),d(),e(),f(),window.requestAnimationFrame(g)}function h(){mb=j(k(ab,_-50,Jb,Cb)),mb.cpt=0,n(l(0,220,150,100,Fb)),ob=[];for(var a=10,b=0;a>b;b++){var c=20+30*O(),d=80+c+(T-2*c-80)*b/a>>0,e=2*O()*M,f=k(0,0,c,Eb);ob.push(j(f));var g=.1+.2*O()*(O()>.5?-1:1);f.da=g/(2*d*M),f.a=e,f.d=d,console.log(f.da)}n(l(150,100,300,30,Gb)),nb=kb.slice(-8);var h=nb[0],i=t(h.x-h.x2,h.y-h.y2),m=2*-L.acos((h.x2-h.x)/i);for(b=0;b<nb.length;b++)h=nb[b],h.l=i,h.ux=h.x2-h.x,h.uy=h.y2-h.y,h.amax=m,(1==h.table||2==h.table)&&(h.amax*=-1)}function i(a,b,c,d){return{x:c||0,y:d||0,shape:a,kind:b,v:{x:0,y:0},a:{x:0,y:0}}}function j(a){return kb.push(a),a}function k(a,b,c,d){var e=i(Ab,d,a,b);return e.r=c,e}function l(a,b,c,d,e){var f=i(Bb,e,a,b);return f.x2=c,f.y2=d,f}function m(a){for(var b=0;4>b;b++){var c=p(a);o(c,"x","y",b),c.shape==Bb&&o(c,"x2","y2",b),j(c),c.table=b}}function n(a){m(a),a.x=Q-a.x,a.shape==Bb&&(a.x2=Q-a.x2),a.mirror=!0,m(a)}function o(a,b,c,d){var e=a[b],f=a[c];if(0===d||2==d)e+=R+S,0===d&&(f=_-f);else{var g=f;f=R+S+e,e=g,1==d&&(e=_-e)}a[b]=e>>0,a[c]=f>>0}function p(a){return JSON.parse(JSON.stringify(a))}function q(a){return a}function r(a){return _-a}function s(a,b,c){return b>a?b:a>c?c:a}function t(a,b){return N(a*a+b*b)}function u(a,b){b=(b||1)/t(a.x,a.y),a.x*=b,a.y*=b}function v(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.r+b.r;return e*e>c*c+d*d}function w(a,b,c){var d=a.x,e=a.y,f=a.r,g=b.x,h=b.y,i=b.x2,j=b.y2,k=i-g,l=j-h,m=L.sqrt(k*k+l*l),n=(i-g)/m,o=(j-h)/m,p=n*(d-g)+o*(e-h),q=p*n+g,r=p*o+h;if((i>g&&q>=g&&i>=q||g>i&&q>=i&&g>=q||g==i&&q==g)&&(j>h&&r>=h&&j>=r||h>j&&r>=j&&h>=r||h==j&&r==h)){var s=r-e,t=q-d,u=N(t*t+s*s);if(f>=u)return c.ex=q,c.ey=r,c.x=-t,c.y=-s,c.l=u,!0}return!1}function x(a,b,c,d,e){b==d?(a.vert=!0,a.x=b):(a.vert=!1,a.m=(c-e)/(b-d),a.p=c-a.m*b)}function y(a,b,c,d){return a.vert?b<a.x:d?b>(c-a.p)/a.m:c>a.m*b+a.p}function z(a,b){var c=J.createElement("canvas");return c.width=a,c.height=b,c}function A(a){return a.getContext("2d")}function B(a,b,c,d,e,f){f&&(a.fillStyle=f.width?a.createPattern(f,"repeat"):f),a.fillRect(b,c,d,e)}function C(){var a=[].slice.call(arguments),b=a.shift();b.drawImage.apply(b,a)}function D(a,b,c,d,e,f,g){a.beginPath(),a.arc(b,c,d,0,2*M,!1),e&&(a.fillStyle=e,a.fill()),f&&(a.lineWidth=g||2,a.strokeStyle=f,a.stroke()),a.closePath()}function E(a,b,c,d,e,f,g){a.strokeStyle=f,a.lineWidth=g||2,a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke()}function F(a){a.clearRect(0,0,U,V)}function G(a,b){b||(b=window.e);var c=b.keyCode;b.charCode&&!c&&(c=b.charCode),Mb[Tb[c]]=a}function H(a,b){var c,d;"which"in b?(c=3==b.which,d=2==b.which):"button"in b&&(c=2==b.button,d=1==b.button),c?Nb.right=a:d?Nb.middle=a:Nb.left=a,Nb.x=b.clientX+X,Nb.y=b.clientY+Y}var I=window,J=I.document,K=J.body,L=I.Math,M=L.PI,N=L.sqrt,O=L.random,P=String.fromCharCode,Q=700,R=200,S=200,T=S+Q/2;T=t(T,T)-S>>0;var U,V,W,X,Y,Z,$,_=Q+2*R+2*S,ab=_/2,bb=20,cb=z(_,_),db=A(cb),eb=z(U,V),fb=A(eb),gb=z(U,V),hb=A(gb),ib=z(U,V),jb=A(ib);window.onresize=function(){U=s(I.innerWidth,Q,_),V=s(I.innerHeight,Q,_),W=L.min(U,V),ib.width=gb.width=eb.width=U-=U%2,ib.height=gb.height=eb.height=V-=V%2},K.onresize(),K.appendChild(eb);var kb,lb,mb,nb,ob,pb="#111",qb="#222",rb="#333",sb="#444",tb="#08e",ub="#000",vb="#0d0",wb="#dd0",xb="#000",yb="#fff",zb="#fa0",Ab="c",Bb="l",Cb="b",Db="bg",Eb="bp",Fb="o",Gb="p",Hb="s",Ib=15,Jb=14,Kb=.2,Lb=.99,Mb={},Nb={},Ob=!1,Pb=0,Qb=100,Rb={},Sb={};D(hb,ab,ab,200,"red"),b(),g();var Tb={37:"left",38:"up",39:"right",40:"down",32:"space",27:"esc",82:"R",13:"Enter"};J.onkeyup=function(a){G(!1,a),27==a.keyCode&&(window._stopped?(window._stopped=!1,window.requestAnimationFrame=window._raf):(window._stopped=!0,window._raf=window.requestAnimationFrame,window.requestAnimationFrame=function(){})),13==a.keyCode&&window._stopped&&g()},J.onkeydown=function(a){G(!0,a)},J.onmousedown=function(a){H(!0,a)},J.onmouseup=function(a){H(!1,a)},J.onmousemove=function(a){Nb.x=a.clientX+X,Nb.y=a.clientY+Y},J.oncontextmenu=function(){return!1}},function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();