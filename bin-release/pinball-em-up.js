/*! pinball-em-up 03-09-2014 */
window.onload=function(){"use strict";function a(){function a(a,b){var c=4;bb.beginPath(),bb.strokeStyle=qb,bb.fillStyle=rb,bb.lineWidth=2,bb.moveTo(a(-c),b(-c)),bb.lineTo(a(Q+R),b(-c)),bb.lineTo(a(Q+R),b(Q)),bb.arcTo(a(Q+R),b(Q+R),a(Q),b(Q+R),R),bb.lineTo(a(-c),b(Q+R)),bb.closePath(),bb.fill(),bb.stroke(),j(k(a(Q),b(Q),R,Ab)),j(l(a(0),b(Q+R),a(Q),b(Q+R),Ab)),j(l(a(Q+R),b(0),a(Q+R),b(Q),Ab)),bb.fillStyle=tb;var h=a==q?f:g;bb.fillText(O(h),a(Q+R+130)-2,b(50)-3),h=b==q?d:e,bb.fillText(O(h),a(50)-2,b(Q+R+130)-3)}var b=z(_,_),c=A(b);B(c,0,0,_,_,nb),B(c,0,0,_-1,_-1,ob),B(c,0,0,_-2,_-2,mb),B(bb,0,0,$,$,b),E(bb,0,0,$,$,pb),E(bb,$,0,0,$,pb),D(bb,$/2,$/2,8,mb,pb);var d=8679,e=8681,f=8678,g=8680;bb.font="64px sans-serif",bb.textAlign="center",bb.textBaseline="middle",a(q,q),a(q,r),a(r,q),a(r,r)}function b(){Mb=0,Lb=!1,ib=[],jb=[],jb.n=0,a(),h()}function c(){if(!Lb){if(Jb.space)Mb++;else if(Mb>0){var a=Mb/Nb;a>1&&(a=1),kb.boostX=3*(1+N()),kb.boostY=-Fb,kb.boostCpt=10+50*a,Lb=!0}Jb.R&&(Lb=!0)}for(var b=0;b<lb.length;b++){var c,d=lb[b],e=!d.mirror;c=1==d.table?e?Jb.up||Jb.right:Jb.down||Jb.left:e?Jb.up||Jb.left:Jb.down||Jb.right;var f=d.ux,g=d.uy;d.cpt=d.cpt||0;var h=7;if(d.max=!1,c?d.cpt<h?d.cpt++:d.max=!0:d.cpt>0&&d.cpt--,d.prevX2=d.x2,d.prevY2=d.y2,d.movingUp=c&&!d.max,d.moving=0!==d.cpt,d.cpt>0){var j=d.amax*(d.cpt/h);d.mirror&&(j*=-1);var k=L.cos(j),l=L.sin(j);f=d.ux*k-d.uy*l,g=d.ux*l+d.uy*k}d._ux=f,d._uy=g,d.x2=d.x+f,d.y2=d.y+g}if(Kb.middle&&(Mb=0,Lb=!0,kb.x=Kb.x,kb.y=Kb.y,kb.a.x=kb.a.y=0,kb.v.x=kb.v.y=0,kb.boostCpt=0,Kb.right=!1,console.log("mouse teleport",kb)),Kb.right&&(Pb.x=Kb.x-kb.x,Pb.y=Kb.y-kb.y,u(Pb),kb.boostCpt=6,kb.boostX=2.5*Pb.x,kb.boostY=2.5*Pb.y,Kb.right=!1),Kb.left&&(Pb.x=Kb.x-kb.x,Pb.y=Kb.y-kb.y,u(Pb),Kb.leftCpt%10===0)){var m;jb.length==jb.n?(m=i(yb,Eb),jb.push(m)):m=jb[jb.n],jb.n++;var n=10;m.x=kb.x+Pb.x*(n+Gb),m.y=kb.y+Pb.y*(n+Gb),m.v.x=Pb.x*n,m.v.y=Pb.y*n,m.cpt=100}Kb.left?Kb.leftCpt++:Kb.leftCpt=0}function d(){var a,b;if(Lb){kb.boostCpt>0&&(kb.boostCpt--,kb.a.x=kb.boostX,kb.a.y=kb.boostY);var c=0,d=0,e=Hb;s=$/2-kb.x,z=$/2-kb.y;var f=T/2,g=t(s,z);f>g&&(s/=g,z/=g,e*=.1+.9*g/f);var h=kb.x-$/2,i=kb.y-$/2;i>h?i>-h?d=e:c=-e:i>-h?c=e:d=-e,kb.a.x+=c,kb.a.y+=d,kb.v.x=kb.v.x+kb.a.x,kb.v.y=kb.v.y+kb.a.y,kb.v.x*=Ib,kb.v.y*=Ib,kb.v.x*kb.v.x+kb.v.y*kb.v.y>Fb*Fb&&u(kb.v,Fb),kb.x+=kb.v.x,kb.y+=kb.v.y,kb.collide=!1;{kb.v.x,kb.v.y}for(a=0,b=ib.length;b>a;a++){var j=ib[a];if(j!=kb){j.collide=!1;var k,l=Pb;if(j.shape==xb)v(kb,j)&&(j.collide=!0,l.x=kb.x-j.x,Pb.y=kb.y-j.y,k=t(l.x,l.y),l.l=j.r+kb.r-k,l.x=l.x/k,l.y=l.y/k);else if(j.shape==yb){var m=j.kind==Db&&j.movingUp;if(!m&&w(kb,j,l)){j.collide=!0,x(Ob,j.x,j.y,j.x2,j.y2);var n=y(Ob,kb.x,kb.y)!==y(Ob,kb.prevX,kb.prevY);0>=n?k=kb.r-l.l:(k=kb.r+l.l,l.x*=-1,l.y*=-1),l.x/=l.l,l.y/=l.l,l.l=k}if(m){var o=w(kb,j,l),p=1==j.table||3==j.table;console.log("rising paddle",j,p?"REVERSE":"");var q,r;if(o?console.log(" paddle direct collision"):(x(Ob,j.x,j.y,j.prevX2,j.prevY2),q=y(Ob,kb.prevX,kb.prevY,p),console.log(" before",0,0,"and",j.prevX2-j.x,j.prevY2-j.y,q,"m",Ob.m,"p",Ob.p),console.log(" ball before:",kb.prevX-j.x,kb.prevY-j.y),x(Ob,j.x,j.y,j.x2,j.y2),r=y(Ob,kb.x,kb.y,p),console.log(" after",0,0,"and",j.x2-j.x,j.y2-j.y,r,"m",Ob.m,"p",Ob.p),console.log(" ball now:",kb.x-j.x,kb.y-j.y)),o||q!==r){o||console.log("  checking dotprod");var s=kb.x-j.x,z=kb.y-j.y,A=s*j._ux+z*j._uy;if((o||A>0)&&(o||s*s+z*z<j.l*j.l)){j.collide=!0;var B=(t(s,z),A/j.l);l.x=j.x+B*j._ux/j.l,l.y=j.y+B*j._uy/j.l,l.x=kb.x-l.x,l.y=kb.y-l.y,l.l=t(l.x,l.y),l.x/=l.l,l.y/=l.l;var C=j._uy/j.l,D=-j._ux/j.l;console.log("   NORMALE PAD",C,D,j),(j.mirror&&(0===j.table||3==j.table)||!j.mirror&&(1==j.table||2==j.table))&&(C*=-1,D*=-1);var E=C*l.x+D*l.y;0>E&&(l.x*=-1,l.y*=-1),l.l=l.l+kb.r,kb.x+=l.x*l.l,kb.y+=l.y*l.l,kb.collide=!0;var F=B/j.l;F=.2+(.3*F+.7*F*F);var G=20*F>>0,H=Fb*F,I=l.x*H,J=l.y*H;kb.boostCpt?(kb.boostCpt+=G>2?2:G,kb.boostX=.2*I+.8*kb.boostX,kb.boostY=.2*J+.8*kb.boostY):(kb.boostCpt=G,kb.boostX=I,kb.boostY=J),kb.boostX*=.6+.8*N(),kb.boostY*=.6+.8*N(),console.log("   boosting",F,kb.boostCpt,kb.boostX,kb.boostY);continue}}}}if(j.collide){kb.x+=l.x*l.l,kb.y+=l.y*l.l,kb.collide=!0;var K=t(kb.v.x,kb.v.y),M=kb.v.x/K,O=kb.v.y/K,P=-l.y,Q=l.x,R=P*M+Q*O;0>R&&(P=-P,Q=-Q);var S=M*l.x+O*l.y;0>S&&(S=-S);var U=L.sin(L.acos(S));0>U&&(U=-U);var V=j.kind==Bb?2:.2;l.x*=S*V*K,l.y*=S*V*K,P*=U*K,Q*=U*K,kb.v.x=l.x+P,kb.v.y=l.y+Q}}}kb.a.x=kb.a.y=0,kb.prevX=kb.x,kb.prevY=kb.y,kb.x+Gb<0?Lb=!1:kb.x-Gb>$?Lb=!1:kb.y+Gb<0?Lb=!1:kb.y-Gb>$&&(Lb=!1)}var W;for(a=0,b=jb.n;b>a;a++)W=jb[a],W.cpt--,W.cpt>0&&(W.x+=W.v.x,W.y+=W.v.y);for(a=0;a<jb.n;a++)W=jb[a],0===W.cpt&&(jb[a]=jb[jb.n-1],jb[jb.n-1]=W,jb.n--,a--)}function e(){Y=W,Z=X;var a=kb.x,b=kb.y,c=a-$/2,d=b-$/2,e=c,f=d;0>e&&(e*=-1),0>f&&(f*=-1);var g=P/2+R;if(g>e&&g>f){var h=e-g,i=f-g,j=h*h+i*i;if(g*g>j){var k=M(j);h=h*g/k,i=i*g/k,a=h+g,b=i+g,0>c&&(a=-a),0>d&&(b=-b),a=$/2+a,b=$/2+b}}else f>e?a=$/2:b=$/2;a=s(a,kb.x-.3*T,kb.x+.3*T),b=s(b,kb.y-.3*U,kb.y+.3*U),a=s(a-T/2,0,$-T),b=s(b-U/2,0,$-U),Lb?(W+=.3*(a-W),X+=.3*(b-X)):(W=a,X=b)}function f(){F(db),F(hb),C(db,eb,0,0),fb.clearRect(0,0,T,U),fb.save(),fb.globalAlpha=.9,C(fb,cb,-W+Y,-X+Z),fb.restore(),F(db),kb.boostCpt>0?(D(fb,kb.x-W,kb.y-X,6,"orange"),D(fb,kb.prevX-W,kb.prevY-X,6,"orange")):D(fb,kb.x-W,kb.y-X,2,"white");for(var a=0,b=ib.length;b>a;a++){var c,d,e,f=ib[a],g=f.x-W,h=f.y-X;if(f.shape==xb){if(f==kb){if(d=ub,c=vb,Mb>0&&!Lb){var i=4*s(Mb/Nb,0,1)>>0;g+=i*N()>>0,h+=i*N()>>0,4==i&&(d="#f00")}}else f.kind==Ab?(c=0,d=0):(e=2,d=qb,c="#000",f.collide&&(d=sb));(c||d)&&D(hb,g,h,f.r,c,d,e)}else f.shape==yb&&(f.kind==Ab?d=0:(d=qb,f.kind==Db&&(d=tb,f.collide&&(d=sb))),d&&E(hb,f.x-W,f.y-X,f.x2-W,f.y2-X,d,2))}var j;for(a=0,b=jb.n;b>a;a++)j=jb[a],D(hb,j.x-W,j.y-X,4,wb),E(fb,j.x-W,j.y-X,j.x-j.v.x-W,j.y-j.v.y-X,wb,2);E(hb,kb.x-W,kb.y-X,kb.x-W+10*kb.v.x,kb.y-X+10*kb.v.y,"#0f0",3),C(db,ab,-W,-X),C(db,eb,0,0),C(db,gb,0,0)}function g(){c(),d(),e(),f(),window.requestAnimationFrame(g)}function h(){kb=j(k($/2,$-50,Gb,zb)),n(l(0,220,150,100,Cb)),m(k(70,260,30,Bb)),m(k(600,400,30,Bb)),m(k(300,600,30,Bb)),n(l(150,100,300,30,Db)),lb=ib.slice(-8);for(var a=lb[0],b=t(a.x-a.x2,a.y-a.y2),c=2*-L.acos((a.x2-a.x)/b),d=0;d<lb.length;d++)a=lb[d],a.l=b,a.ux=a.x2-a.x,a.uy=a.y2-a.y,a.amax=c,(1==a.table||2==a.table)&&(a.amax*=-1)}function i(a,b,c,d){return{x:c||0,y:d||0,shape:a,kind:b,v:{x:0,y:0},a:{x:0,y:0}}}function j(a){return ib.push(a),a}function k(a,b,c,d){var e=i(xb,d,a,b);return e.r=c,e}function l(a,b,c,d,e){var f=i(yb,e,a,b);return f.x2=c,f.y2=d,f}function m(a){for(var b=0;4>b;b++){var c=p(a);o(c,"x","y",b),c.shape==yb&&o(c,"x2","y2",b),j(c),c.table=b}}function n(a){m(a),a.x=P-a.x,a.shape==yb&&(a.x2=P-a.x2),a.mirror=!0,m(a)}function o(a,b,c,d){var e=a[b],f=a[c];if(0===d||2==d)e+=Q+R,0===d&&(f=$-f);else{var g=f;f=Q+R+e,e=g,1==d&&(e=$-e)}a[b]=e>>0,a[c]=f>>0}function p(a){return JSON.parse(JSON.stringify(a))}function q(a){return a}function r(a){return $-a}function s(a,b,c){return b>a?b:a>c?c:a}function t(a,b){return M(a*a+b*b)}function u(a,b){b=(b||1)/t(a.x,a.y),a.x*=b,a.y*=b}function v(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.r+b.r;return e*e>c*c+d*d}function w(a,b,c){var d=a.x,e=a.y,f=a.r,g=b.x,h=b.y,i=b.x2,j=b.y2,k=i-g,l=j-h,m=L.sqrt(k*k+l*l),n=(i-g)/m,o=(j-h)/m,p=n*(d-g)+o*(e-h),q=p*n+g,r=p*o+h;if((i>g&&q>=g&&i>=q||g>i&&q>=i&&g>=q||g==i&&q==g)&&(j>h&&r>=h&&j>=r||h>j&&r>=j&&h>=r||h==j&&r==h)){var s=r-e,t=q-d,u=M(t*t+s*s);if(f>=u)return c.ex=q,c.ey=r,c.x=-t,c.y=-s,c.l=u,!0}return!1}function x(a,b,c,d,e){b==d?(a.vert=!0,a.x=b):(a.vert=!1,a.m=(c-e)/(b-d),a.p=c-a.m*b)}function y(a,b,c,d){return a.vert?b<a.x:d?b>(c-a.p)/a.m:c>a.m*b+a.p}function z(a,b){var c=J.createElement("canvas");return c.width=a,c.height=b,c}function A(a){return a.getContext("2d")}function B(a,b,c,d,e,f){f&&(a.fillStyle=f.width?a.createPattern(f,"repeat"):f),a.fillRect(b,c,d,e)}function C(){var a=[].slice.call(arguments),b=a.shift();b.drawImage.apply(b,a)}function D(a,b,c,d,e,f,g){a.beginPath(),a.arc(b,c,d,0,2*L.PI,!1),e&&(a.fillStyle=e,a.fill()),f&&(a.lineWidth=g||2,a.strokeStyle=f,a.stroke())}function E(a,b,c,d,e,f,g){g&&(a.lineWidth=g),f&&(a.strokeStyle=f),a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke()}function F(a){a.clearRect(0,0,T,U)}function G(a,b){b||(b=window.e);var c=b.keyCode;b.charCode&&!c&&(c=b.charCode),Jb[Qb[c]]=a}function H(a,b){var c,d;"which"in b?(c=3==b.which,d=2==b.which):"button"in b&&(c=2==b.button,d=1==b.button),c?Kb.right=a:d?Kb.middle=a:Kb.left=a,Kb.x=b.clientX+W,Kb.y=b.clientY+X}var I=window,J=I.document,K=J.body,L=I.Math,M=L.sqrt,N=(M(2),L.random),O=String.fromCharCode,P=700,Q=200,R=200,S=R+P/2;S=t(S,S)-R>>0;var T,U,V,W,X,Y,Z,$=P+2*Q+2*R,_=20,ab=z($,$),bb=A(ab),cb=z(T,U),db=A(cb),eb=z(T,U),fb=A(eb),gb=z(T,U),hb=A(gb);window.onresize=function(){T=s(I.innerWidth,P,$),U=s(I.innerHeight,P,$),V=L.min(T,U),gb.width=eb.width=cb.width=T-=T%2,gb.height=eb.height=cb.height=U-=U%2},K.onresize(),K.appendChild(cb);var ib,jb,kb,lb,mb="#111",nb="#222",ob="#333",pb="#444",qb="#08e",rb="#000",sb="#0d0",tb="#dd0",ub="#000",vb="#fff",wb="#fa0",xb="c",yb="l",zb="b",Ab="bg",Bb="bp",Cb="o",Db="p",Eb="s",Fb=15,Gb=14,Hb=.2,Ib=.99,Jb={},Kb={},Lb=!1,Mb=0,Nb=100,Ob={},Pb={};D(fb,$/2,$/2,200,"red"),b(),g();var Qb={37:"left",38:"up",39:"right",40:"down",32:"space",27:"esc",82:"R",13:"Enter"};J.onkeyup=function(a){G(!1,a),27==a.keyCode&&(window._stopped?(window._stopped=!1,window.requestAnimationFrame=window._raf):(window._stopped=!0,window._raf=window.requestAnimationFrame,window.requestAnimationFrame=function(){})),13==a.keyCode&&window._stopped&&g()},J.onkeydown=function(a){G(!0,a)},J.onmousedown=function(a){H(!0,a)},J.onmouseup=function(a){H(!1,a)},J.onmousemove=function(a){Kb.x=a.clientX+W,Kb.y=a.clientY+X},J.oncontextmenu=function(){return!1}},function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();